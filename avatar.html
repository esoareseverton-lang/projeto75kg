<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Evolução 3D — Avatar Realista (DEBUG)</title>
  <style>
    :root{ --bg:#071124; --card:#0b1220; --muted:#9fb0c6; }
    html,body{ height:100%; margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial; color:#e6eef8; background:linear-gradient(180deg,#071124,#04101a); }
    .wrap{ max-width:1200px; margin:20px auto; padding:16px; display:grid; grid-template-columns:1fr 340px; gap:16px; }
    .card{ background:var(--card); padding:14px; border-radius:12px; border:1px solid rgba(255,255,255,0.05); box-shadow:0 8px 28px rgba(0,0,0,0.5); }
    h1{ margin:0 0 6px; font-size:18px; }
    p.muted{ margin:0 0 10px; font-size:13px; color:var(--muted); }
    #viewport{ width:100%; height:560px; border-radius:10px; background:#050b18; overflow:hidden; position:relative; }
    .status{ position:absolute; left:10px; bottom:10px; background:rgba(0,0,0,0.45); padding:6px 10px; border-radius:6px; font-size:13px; color:#dff; }
    label{ font-size:13px; color:var(--muted); display:block; margin-bottom:4px; }
    input, select, button { width:100%; padding:8px; border-radius:8px; background:transparent; border:1px solid rgba(255,255,255,0.08); color:white; margin-bottom:10px; }
    .small { width:auto; display:inline-block; padding:8px 10px; margin-right:8px; }
    .btn-primary{ background:linear-gradient(90deg,#06b6d4,#10b981); color:#021015; border:none; }
    .btn-ghost{ background:transparent; border:1px solid rgba(255,255,255,0.08); color:var(--muted); }
    .history{ max-height:260px; overflow-y:auto; display:flex; flex-direction:column; gap:6px; margin-top:10px; }
    .histItem{ padding:8px; background:rgba(255,255,255,0.06); border-radius:8px; font-size:13px; }
    footer{ margin-top:14px; text-align:center; font-size:12px; color:var(--muted); }
    @media(max-width:900px){ .wrap{ grid-template-columns:1fr; } #viewport{ height:420px; } }
  </style>
</head>
<body>
<div class="wrap">

  <div class="card">
    <h1>Avatar 3D — Teste Realista</h1>
    <p class="muted">Clique em "Carregar modelo realista de teste" para ver um GLB humano real carregado diretamente no navegador.</p>

    <div id="viewport">
      <div id="status" class="status">Status: Inativo</div>
    </div>

    <div style="display:flex;gap:8px;margin-top:10px">
      <button id="btnLoadTest" class="small btn-primary">Carregar modelo realista de teste</button>
      <button id="btnLoadMale" class="small btn-ghost">Forçar modelo masculino</button>
      <button id="btnLoadFemale" class="small btn-ghost">Forçar modelo feminino</button>
    </div>

    <div style="margin-top:12px">
      <label>Selecione seu próprio .glb (URL)</label>
      <input id="customUrl" placeholder="Cole aqui a URL direta para um .glb (CORS habilitado)" />
      <button id="btnLoadCustom" class="small btn-ghost">Carregar URL personalizada</button>
    </div>

    <div style="margin-top:12px">
      <p class="muted">Se o modelo não carregar: verá a mensagem de erro aqui e no console (F12). Cole a mensagem do console aqui que eu corrijo.</p>
    </div>
  </div>

  <div class="card">
    <h1>Instruções rápidas</h1>
    <p class="muted">Use o botão de teste para confirmar que seu navegador mostra um humano realista. Depois cole sua URL .glb (se tiver) e clique em "Carregar URL personalizada".</p>
    <div style="margin-top:10px">
      <strong>Observações úteis:</strong>
      <ul style="color:var(--muted)">
        <li>Se aparecer o boneco quadrado, procurar por erros no Console (F12 → Console).</li>
        <li>Se a URL do .glb retornar erro de CORS, precisaremos hospedar o arquivo em lugar com CORS ativo (eu te explico).</li>
      </ul>
    </div>
    <footer>Quando estiver ok, eu atualizo seu arquivo principal com as mesmas URLs.</footer>
  </div>

</div>

<!-- importmap para three -->
<script type="importmap">
{
  "imports": {
    "three": "https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.module.js"
  }
}
</script>

<script type="module">
import * as THREE from "https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.module.js";
import { OrbitControls } from "https://cdn.jsdelivr.net/npm/three@0.152.2/examples/jsm/controls/OrbitControls.js";
import { GLTFLoader } from "https://cdn.jsdelivr.net/npm/three@0.152.2/examples/jsm/loaders/GLTFLoader.js";

/* ---------- Scene basic ---------- */
const container = document.getElementById('viewport');
const statusEl = document.getElementById('status');

const scene = new THREE.Scene();
scene.background = new THREE.Color(0x050b18);

const camera = new THREE.PerspectiveCamera(36, 1, 0.1, 100);
camera.position.set(0, 1.6, 6);

const renderer = new THREE.WebGLRenderer({ antialias: true });
renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
container.appendChild(renderer.domElement);

const controls = new OrbitControls(camera, renderer.domElement);
controls.enablePan = false;
controls.maxPolarAngle = Math.PI / 2;

const hemi = new THREE.HemisphereLight(0xffffff, 0x444444, 0.7);
scene.add(hemi);
const dir = new THREE.DirectionalLight(0xffffff, 0.8);
dir.position.set(5, 10, 7);
scene.add(dir);
const rim = new THREE.DirectionalLight(0xfff6e0, 0.15);
rim.position.set(-5, 2, -3);
scene.add(rim);

/* ground - subtle */
const ground = new THREE.Mesh(new THREE.PlaneGeometry(40,40), new THREE.MeshStandardMaterial({color:0x000000, transparent:true, opacity:0}));
ground.rotation.x = -Math.PI/2;
scene.add(ground);

function resize() {
  const w = Math.max(320, container.clientWidth || 320);
  const h = Math.max(240, container.clientHeight || 240);
  renderer.setSize(w,h);
  camera.aspect = w/h;
  camera.updateProjectionMatrix();
  controls.update();
}
window.addEventListener('resize', resize);
resize();

const loader = new GLTFLoader();

/* utility: set status on page and console */
function setStatus(msg, isError=false) {
  statusEl.textContent = "Status: " + msg;
  statusEl.style.background = isError ? "rgba(120,10,10,0.6)" : "rgba(0,80,60,0.6)";
  console.log("[AVATAR STATUS]", msg);
}

/* helper to clear existing model(s) */
let currentModelGroup = null;
function clearModel() {
  if (currentModelGroup) {
    scene.remove(currentModelGroup);
    currentModelGroup.traverse(n => {
      if (n.geometry) n.geometry.dispose();
      if (n.material) {
        if (Array.isArray(n.material)) n.material.forEach(m=>m.dispose && m.dispose());
        else n.material.dispose && n.material.dispose();
      }
    });
    currentModelGroup = null;
  }
}

/* helper to add and center model */
function addModelToScene(gltfScene, scale=1.0) {
  clearModel();
  const root = gltfScene.clone(true);
  // clone materials to avoid shared state
  root.traverse(node => {
    if (node.isMesh && node.material) node.material = node.material.clone();
  });
  root.scale.set(scale, scale, scale);
  // center model: compute bbox and shift
  const bbox = new THREE.Box3().setFromObject(root);
  const center = bbox.getCenter(new THREE.Vector3());
  // move model so center.x -> 0 and base sits at y=0
  const size = bbox.getSize(new THREE.Vector3());
  const yShift = bbox.min.y; // lowest point
  root.position.x -= center.x;
  root.position.z -= center.z;
  root.position.y -= yShift; // bring feet to ground plane
  scene.add(root);
  currentModelGroup = root;
}

/* tried-and-true test model (works in three.js examples) */
const TEST_MODEL = "https://threejs.org/examples/models/gltf/LeePerrySmith/LeePerrySmith.glb";

/* alternative human test (if you want another) */
const ALT_TEST = "https://cdn.jsdelivr.net/gh/mrdoob/three.js@master/examples/models/gltf/RobotExpressive/RobotExpressive.glb";

/* readyplayer.me sample URLs (may redirect / require CORS) - not used by default here
   Keep as reference if you want to test: 
   https://models.readyplayer.me/646d1b75be30f89a3d922b35.glb
   https://models.readyplayer.me/646d1b9a21db005edec50a18.glb
*/

/* load GLB helper with detailed logging */
async function loadAndShow(url, desiredScale=1.0) {
  setStatus("Carregando: " + url);
  console.log("Loading GLB:", url);
  try {
    const gltf = await new Promise((resolve, reject) => {
      loader.load(url, (g) => resolve(g), (xhr) => {
        // progress (optional)
      }, (err) => reject(err));
    });
    if (!gltf || !gltf.scene) throw new Error("Arquivo GLB carregado mas sem scene");
    addModelToScene(gltf.scene, desiredScale);
    setStatus("Modelo carregado com sucesso");
    return true;
  } catch (err) {
    console.error("GLB load failed:", err);
    setStatus("Falha ao carregar GLB — veja console (F12) para erro", true);
    return false;
  }
}

/* Buttons */
document.getElementById('btnLoadTest').onclick = async () => {
  await loadAndShow(TEST_MODEL, 1.8);
};
document.getElementById('btnLoadMale').onclick = async () => {
  // quick human-like test (use same test model or replace by your URL)
  await loadAndShow(TEST_MODEL, 1.8);
};
document.getElementById('btnLoadFemale').onclick = async () => {
  // alternate expressive robot (not human) just to show variation
  await loadAndShow(ALT_TEST, 0.9);
};

document.getElementById('btnLoadCustom').onclick = async () => {
  const url = document.getElementById('customUrl').value.trim();
  if (!url) return alert("Cole a URL direta de um .glb no campo acima.");
  const ok = await loadAndShow(url, 1.0);
  if (!ok) {
    alert("Falha ao carregar seu .glb. Abra o Console (F12) -> Console e cole a mensagem de erro aqui que eu te digo o motivo.");
  }
};

/* small orbit animation */
function animate() {
  requestAnimationFrame(animate);
  renderer.render(scene, camera);
}
animate();

setStatus("Pronto — carregue um modelo de teste");
</script>
</body>
</html>
