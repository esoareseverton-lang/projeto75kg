<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Evolu√ß√£o 3D ‚Äî Avatar</title>

  <style>
    :root{
      --bg:#071124;
      --card:#0b1220;
      --muted:#9fb0c6;
    }
    html,body{
      height:100%;
      margin:0;
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;
      color:#e6eef8;
      background:linear-gradient(180deg,#071124,#04101a);
    }
    .wrap{
      max-width:1200px;
      margin:20px auto;
      padding:16px;
      display:grid;
      grid-template-columns:1fr 340px;
      gap:16px;
    }
    .card{
      background:var(--card);
      padding:14px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.05);
      box-shadow:0 8px 28px rgba(0,0,0,0.5);
    }
    h1{
      margin:0 0 6px;
      font-size:18px;
    }
    p.muted{
      margin:0 0 10px;
      font-size:13px;
      color:var(--muted);
    }
    #viewport{
      width:100%;
      height:560px;
      border-radius:10px;
      background:#050b18;
      overflow:hidden;
    }
    label{
      font-size:13px;
      color:var(--muted);
      display:block;
      margin-bottom:4px;
    }
    input{
      width:100%;
      padding:8px;
      border-radius:8px;
      background:transparent;
      border:1px solid rgba(255,255,255,0.08);
      color:white;
      margin-bottom:10px;
    }
    .btn{
      padding:10px 12px;
      border-radius:10px;
      border:none;
      cursor:pointer;
      font-weight:600;
    }
    .btn-primary{
      background:linear-gradient(90deg,#06b6d4,#10b981);
      color:#021015;
    }
    .btn-ghost{
      background:transparent;
      border:1px solid rgba(255,255,255,0.08);
      color:var(--muted);
    }

    .progressBar{
      height:14px;
      background:rgba(255,255,255,0.07);
      border-radius:999px;
      overflow:hidden;
      margin-top:6px;
    }
    .fill{
      height:100%;
      width:0%;
      background:linear-gradient(90deg,#06b6d4,#10b981);
      transition:width .5s ease;
    }

    .history{
      max-height:260px;
      overflow-y:auto;
      display:flex;
      flex-direction:column;
      gap:6px;
      margin-top:10px;
    }
    .histItem{
      padding:8px;
      background:rgba(255,255,255,0.06);
      border-radius:8px;
      font-size:13px;
    }

    footer{
      margin-top:14px;
      text-align:center;
      font-size:12px;
      color:var(--muted);
    }

    @media(max-width:900px){
      .wrap{
        grid-template-columns:1fr;
      }
      #viewport{
        height:420px;
      }
    }
  </style>
</head>

<body>

<div class="wrap">

  <!-- üü¶ Coluna do Avatar (3 bonecos lado a lado) -->
  <div class="card">
    <h1>Avatar 3D ‚Äî Atual ¬∑ Semana ¬∑ Meta</h1>
    <p class="muted">Ajuste as medidas ‚Üí Salve ‚Üí Compare com semanas ‚Üí Veja evolu√ß√£o visual.</p>

    <div id="viewport"></div>

    <div style="display:flex;gap:10px;margin-top:10px;flex-wrap:wrap">
      <button id="saveWeigh" class="btn btn-primary">Salvar Pesagem</button>
      <button id="saveMeta" class="btn btn-ghost">Salvar Meta</button>
      <button id="exportCSV" class="btn btn-ghost">Exportar CSV</button>
    </div>

    <div style="margin-top:12px;display:grid;grid-template-columns:repeat(3,1fr);gap:10px">
      <div>
        <label>Peso Atual (kg)</label>
        <input id="w" type="number" step="0.1">
      </div>
      <div>
        <label>Altura (m)</label>
        <input id="h" type="number" step="0.01">
      </div>
      <div>
        <label>Meta (kg)</label>
        <input id="t" type="number" step="0.1">
      </div>
    </div>

    <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:10px">
      <div><label>Bra√ßo</label><input id="arm" type="number" step="0.1"></div>
      <div><label>Peito</label><input id="chest" type="number" step="0.1"></div>
      <div><label>Barriga</label><input id="waist" type="number" step="0.1"></div>
      <div><label>Coxa</label><input id="thigh" type="number" step="0.1"></div>
    </div>

    <div style="margin-top:12px">
      <div style="display:flex;justify-content:space-between">
        <strong>Progresso</strong>
        <span id="percent" style="color:var(--muted)">0%</span>
      </div>
      <div class="progressBar"><div class="fill" id="bar"></div></div>
      <p id="msg" class="muted" style="margin-top:6px">Registre uma pesagem para come√ßar.</p>
    </div>

  </div>

  <!-- üü™ Coluna do Hist√≥rico -->
  <div class="card">
    <h1>Hist√≥rico</h1>
    <p class="muted">Selecione uma semana para ver o boneco correspondente no centro.</p>

    <select id="weekSel" style="width:100%;padding:8px;margin-bottom:8px;border-radius:8px;background:#050b18;color:white;border:1px solid rgba(255,255,255,0.08)">
      <option value="">-- Selecione semana --</option>
    </select>

    <button id="delWeek" class="btn btn-ghost" style="width:100%;margin-bottom:10px">Excluir Semana</button>

    <div id="history" class="history"></div>

    <footer>Entradas salvas: <span id="count">0</span></footer>

  </div>

</div>

<!-- ‚öôÔ∏è SCRIPT 3D + L√ìGICA -->
<script type="module">
  /* IMPORTA√á√ÉO 100% COMPAT√çVEL COM GITHUB PAGES */
  import * as THREE from "https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.module.js";
  import { OrbitControls } from "https://cdn.jsdelivr.net/npm/three@0.152.2/examples/jsm/controls/OrbitControls.js";

  /* ------------------------------
       STORAGE LOCAL
  ------------------------------ */
  const META_KEY = "fb_meta";
  const WEEKS_KEY = "fb_weeks";

  function loadMeta() {
    return JSON.parse(localStorage.getItem(META_KEY) || "{}");
  }
  function saveMeta(v) {
    localStorage.setItem(META_KEY, JSON.stringify(v));
  }
  function loadWeeks() {
    return JSON.parse(localStorage.getItem(WEEKS_KEY) || "[]");
  }
  function saveWeeks(arr) {
    localStorage.setItem(WEEKS_KEY, JSON.stringify(arr));
  }

  /* ------------------------------
      ELEMENTOS HTML
  ------------------------------ */
  const elW = document.getElementById("w");
  const elH = document.getElementById("h");
  const elT = document.getElementById("t");

  const elArm = document.getElementById("arm");
  const elChest = document.getElementById("chest");
  const elWaist = document.getElementById("waist");
  const elThigh = document.getElementById("thigh");

  const percentLabel = document.getElementById("percent");
  const bar = document.getElementById("bar");
  const msg = document.getElementById("msg");

  const weekSel = document.getElementById("weekSel");
  const historyDiv = document.getElementById("history");
  const count = document.getElementById("count");

  /* ------------------------------
      3D ‚Äî CENA
  ------------------------------ */
  const container = document.getElementById("viewport");
  const scene = new THREE.Scene();
  scene.background = new THREE.Color(0x050b18);

  const camera = new THREE.PerspectiveCamera(
    36,
    container.clientWidth / container.clientHeight,
    0.1,
    100
  );
  camera.position.set(0, 1.4, 6);

  const renderer = new THREE.WebGLRenderer({ antialias: true });
  renderer.setSize(container.clientWidth, container.clientHeight);
  container.appendChild(renderer.domElement);

  const controls = new OrbitControls(camera, renderer.domElement);
  controls.enablePan = false;
  controls.maxPolarAngle = Math.PI / 2;

  scene.add(new THREE.AmbientLight(0xffffff, 0.7));
  const dl = new THREE.DirectionalLight(0xffffff, 0.6);
  dl.position.set(5, 8, 5);
  scene.add(dl);

  /* ------------------------------
      FUN√á√ÉO PARA CRIAR BONECO
  ------------------------------ */
  function createAvatar(color = 0x77c0e0) {
    const g = new THREE.Group();

    const matSkin = new THREE.MeshStandardMaterial({ color: 0xf2c9a6 });

    // cabe√ßa
    const head = new THREE.Mesh(new THREE.SphereGeometry(0.28, 28, 28), matSkin);
    head.position.set(0, 1.45, 0);
    g.add(head);

    // olhos
    const eyeMat = new THREE.MeshStandardMaterial({ color: 0x111111 });
    const eyeL = new THREE.Mesh(new THREE.SphereGeometry(0.12, 12, 12), eyeMat);
    eyeL.position.set(-0.09, 1.5, 0.26);
    const eyeR = eyeL.clone();
    eyeR.position.x = 0.09;
    g.add(eyeL, eyeR);

    // boca
    const mouth = new THREE.Mesh(
      new THREE.BoxGeometry(0.22, 0.04, 0.02),
      new THREE.MeshStandardMaterial({ color: 0x7b2e2e })
    );
    mouth.position.set(0, 1.38, 0.26);
    g.add(mouth);

    // tronco
    const torso = new THREE.Mesh(
      new THREE.BoxGeometry(0.45, 0.6, 0.28),
      new THREE.MeshStandardMaterial({ color })
    );
    torso.position.set(0, 0.8, 0);
    g.add(torso);

    // bra√ßos
    const arm = new THREE.Mesh(
      new THREE.CylinderGeometry(0.08, 0.08, 0.5, 16),
      matSkin
    );
    const armL = arm.clone();
    armL.position.set(-0.46, 0.9, 0);
    armL.rotation.z = 0.12;

    const armR = arm.clone();
    armR.position.set(0.46, 0.9, 0);
    armR.rotation.z = -0.12;

    g.add(armL, armR);

    // pernas
    const legMat = new THREE.MeshStandardMaterial({ color: 0x5a4e4e });
    const leg = new THREE.Mesh(
      new THREE.CylinderGeometry(0.1, 0.1, 0.6, 16),
      legMat
    );

    const legL = leg.clone();
    legL.position.set(-0.16, 0.22, 0);
    const legR = leg.clone();
    legR.position.set(0.16, 0.22, 0);

    g.add(legL, legR);

    return { group: g, head, eyeL, eyeR, mouth, torso, armL, armR, legL, legR };
  }

  /* ------------------------------
      3 BONECOS: atual ¬∑ semana ¬∑ meta
  ------------------------------ */
  const avatarCurrent = createAvatar(0x3ba3f7);
  const avatarWeek = createAvatar(0x66cc99);
  const avatarTarget = createAvatar(0xffc94d);

  avatarCurrent.group.position.x = -2.2;
  avatarWeek.group.position.x = 0;
  avatarTarget.group.position.x = 2.2;

  scene.add(avatarCurrent.group);
  scene.add(avatarWeek.group);
  scene.add(avatarTarget.group);

  /* ------------------------------
      APLICAR MEDIDAS NO BONECO
  ------------------------------ */
  function applyMeasures(avatar, m) {
    const h = m.height || 1.75;

    const scaleH = Math.max(0.65, Math.min(1.35, (h - 1.2) / 1.2));
    avatar.group.scale.set(scaleH, scaleH, scaleH);

    const chest = m.chest || 95;
    const scaleW = Math.max(0.7, Math.min(1.5, (chest - 70) / 50 + 1));
    avatar.torso.scale.x = scaleW;
    avatar.torso.scale.z = scaleW * 0.8;

    const leg = m.thigh || 55;
    const arm = m.arm || 30;

    const armScale = Math.max(0.6, Math.min(1.6, arm / 30));
    avatar.armL.scale.set(armScale, armScale, armScale);
    avatar.armR.scale.set(armScale, armScale, armScale);

    const legScale = Math.max(0.6, Math.min(1.6, leg / 50));
    avatar.legL.scale.set(legScale, legScale, legScale);
    avatar.legR.scale.set(legScale, legScale, legScale);
  }

  /* ------------------------------
      RENDER LOOP
  ------------------------------ */
  function animate() {
    requestAnimationFrame(animate);

    avatarCurrent.group.rotation.y += 0.003;
    avatarWeek.group.rotation.y += 0.003;
    avatarTarget.group.rotation.y += 0.003;

    renderer.render(scene, camera);
  }
  animate();

  /* ------------------------------
      FUN√á√ïES DE PROGRESSO
  ------------------------------ */
  function calcPercent(initial, current, target) {
    if (!initial || !current || !target) return 0;
    if (initial === target) return 100;

    const losing = target < initial;
    if (losing) {
      const total = initial - target;
      const done = initial - current;
      return Math.min(100, Math.max(0, (done / total) * 100));
    } else {
      const total = target - initial;
      const done = current - initial;
      return Math.min(100, Math.max(0, (done / total) * 100));
    }
  }

  /* ------------------------------
      CARREGAR DADOS
  ------------------------------ */
  let meta = loadMeta();
  let weeks = loadWeeks();

  function refreshUI() {
    elW.value = meta.currentWeight || 80;
    elH.value = meta.height || 1.75;
    elT.value = meta.targetWeight || 75;

    elArm.value = meta.arm || 30;
    elChest.value = meta.chest || 95;
    elWaist.value = meta.waist || 85;
    elThigh.value = meta.thigh || 55;

    applyMeasures(avatarCurrent, meta);
    applyMeasures(avatarTarget, { ...meta, weight: meta.targetWeight });

    weekSel.innerHTML = `<option value="">-- Selecione semana --</option>`;
    historyDiv.innerHTML = "";

    weeks.forEach(w => {
      const opt = document.createElement("option");
      opt.value = w.id;
      opt.textContent = `${new Date(w.date).toLocaleDateString()} ‚Äî ${w.weight}kg`;
      weekSel.appendChild(opt);

      const div = document.createElement("div");
      div.className = "histItem";
      div.textContent = `${new Date(w.date).toLocaleString()} ‚Äî ${w.weight}kg`;
      historyDiv.appendChild(div);
    });

    count.textContent = weeks.length;

    const initial = weeks.length ? weeks[0].weight : elW.value;
    const pct = calcPercent(initial, elW.value, elT.value);

    percentLabel.textContent = pct.toFixed(0) + "%";
    bar.style.width = pct + "%";

    msg.textContent =
      pct >= 95
        ? "Quase l√°!"
        : pct >= 50
        ? "√ìtimo progresso!"
        : pct >= 20
        ? "Continue firme!"
        : "Come√ßando bem!";

    // boneco week selecionado
    const wk = weeks.find(x => x.id === weekSel.value);
    if (wk) applyMeasures(avatarWeek, wk);
    else applyMeasures(avatarWeek, meta);
  }

  refreshUI();

  /* ------------------------------
      EVENTOS
  ------------------------------ */
  saveWeigh.onclick = () => {
    const w = parseFloat(elW.value);
    if (!w) return alert("Peso inv√°lido!");

    const entry = {
      id: "w" + Date.now(),
      weight: w,
      height: parseFloat(elH.value),
      arm: parseFloat(elArm.value),
      chest: parseFloat(elChest.value),
      waist: parseFloat(elWaist.value),
      thigh: parseFloat(elThigh.value),
      date: new Date().toISOString()
    };

    weeks.push(entry);
    saveWeeks(weeks);
    refreshUI();
  };

  saveMeta.onclick = () => {
    meta = {
      currentWeight: parseFloat(elW.value),
      height: parseFloat(elH.value),
      targetWeight: parseFloat(elT.value),
      arm: parseFloat(elArm.value),
      chest: parseFloat(elChest.value),
      waist: parseFloat(elWaist.value),
      thigh: parseFloat(elThigh.value)
    };
    saveMeta(meta);
    refreshUI();
  };

  exportCSV.onclick = () => {
    if (!weeks.length) return alert("Sem dados!");

    const rows = [
      "date,weight,height,arm,chest,waist,thigh"
    ];

    weeks.forEach(w => {
      rows.push(
        `${w.date},${w.weight},${w.height},${w.arm},${w.chest},${w.waist},${w.thigh}`
      );
    });

    const blob = new Blob([rows.join("\n")], { type: "text/csv" });
    const url = URL.createObjectURL(blob);
    window.open(url, "_blank");
  };

  weekSel.onchange = refreshUI;

  delWeek.onclick = () => {
    if (!weekSel.value) return alert("Selecione primeiro.");
    weeks = weeks.filter(w => w.id !== weekSel.value);
    saveWeeks(weeks);
    weekSel.value = "";
    refreshUI();
  };
</script>

</body>
</html>
