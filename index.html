<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Evolu√ß√£o Dark Premium</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #05060a;
      --card: #101320;
      --accent: #4cc9f0;
      --accent2: #f72585;
      --accent3: #43d9a3;
      --text: #f5f5f5;
      --muted: #8a8fa3;
      --border: #222533;
      --danger: #ff4b81;
      --warning: #ffb347;
    }
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    body {
      margin: 0;
      background: radial-gradient(circle at top, #141b2d, #05060a);
      color: var(--text);
      min-height: 100vh;
    }
    .shell {
      max-width: 1100px;
      margin: 0 auto;
      padding: 20px 12px 40px;
    }
    .card {
      background: linear-gradient(145deg, #111521, #090b12);
      border-radius: 18px;
      padding: 18px 16px;
      border: 1px solid var(--border);
      box-shadow: 0 18px 55px rgba(0,0,0,0.6);
      margin-bottom: 18px;
    }
    h1, h2, h3 {
      margin: 0 0 8px;
    }
    h1 {
      font-size: 1.8rem;
      letter-spacing: 0.06em;
      text-transform: uppercase;
    }
    h2 {
      font-size: 1.15rem;
    }
    .subtitle {
      font-size: 0.9rem;
      color: var(--muted);
      margin-top: 4px;
    }
    .badge-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 6px;
    }
    .badge {
      font-size: 0.75rem;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      color: var(--muted);
    }
    .badge-accent {
      border-color: var(--accent);
      color: var(--accent);
    }
    .meta-row {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      margin-top: 10px;
      font-size: 0.85rem;
      color: var(--muted);
    }
    .meta-label {
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-size: 0.7rem;
      color: #6b7086;
    }
    .small {
      font-size: 0.75rem;
      color: var(--muted);
      margin-top: 6px;
    }
    label {
      display: block;
      font-size: 0.78rem;
      margin-bottom: 3px;
      color: var(--muted);
    }
    input, select, textarea {
      width: 100%;
      padding: 8px 9px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #070910;
      color: var(--text);
      font-size: 0.85rem;
      outline: none;
      resize: vertical;
    }
    input:focus, select:focus, textarea:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(76,201,240,0.3);
    }
    .grid-2 {
      display: grid;
      grid-template-columns: minmax(0,1.3fr) minmax(0,1.1fr);
      gap: 16px;
    }
    @media (max-width: 880px) {
      .grid-2 {
        grid-template-columns: minmax(0,1fr);
      }
    }
    .form-grid-compact {
      display: grid;
      grid-template-columns: repeat(4, minmax(0,1fr));
      gap: 8px;
    }
    @media (max-width: 880px) {
      .form-grid-compact {
        grid-template-columns: repeat(2, minmax(0,1fr));
      }
    }
    @media (max-width: 520px) {
      .form-grid-compact {
        grid-template-columns: minmax(0,1fr);
      }
    }
    .form-grid-3 {
      display: grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap: 8px;
    }
    @media (max-width: 720px) {
      .form-grid-3 {
        grid-template-columns: repeat(2, minmax(0,1fr));
      }
    }
    @media (max-width: 480px) {
      .form-grid-3 {
        grid-template-columns: minmax(0,1fr);
      }
    }
    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
    }
    button {
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 0.82rem;
      padding: 9px 14px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      font-weight: 500;
      letter-spacing: 0.04em;
      text-transform: uppercase;
    }
    .btn-primary {
      background: linear-gradient(135deg, var(--accent), #4895ef);
      color: #020308;
      box-shadow: 0 12px 30px rgba(72,149,239,0.45);
    }
    .btn-ghost {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--muted);
    }
    .btn-danger {
      background: transparent;
      border: 1px solid var(--danger);
      color: var(--danger);
    }
    @media (max-width: 600px) {
      .btn-row {
        flex-direction: column;
      }
      .btn-primary, .btn-ghost, .btn-danger {
        width: 100%;
      }
    }
    .table-wrap {
      overflow-x: auto;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: #05060b;
      -webkit-overflow-scrolling: touch;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.78rem;
      min-width: 620px;
    }
    thead {
      background: linear-gradient(90deg, #101320, #15192a);
    }
    th, td {
      padding: 7px 9px;
      text-align: left;
      white-space: nowrap;
    }
    th {
      font-weight: 600;
      font-size: 0.75rem;
      color: #c4c7de;
      border-bottom: 1px solid var(--border);
    }
    tbody tr:nth-child(even) {
      background: rgba(255,255,255,0.015);
    }
    tbody tr:hover {
      background: rgba(76,201,240,0.06);
    }
    .pill {
      padding: 2px 7px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.12);
      font-size: 0.7rem;
      color: var(--muted);
    }
    .progress-bar-wrap {
      width: 100%;
      background: #05060b;
      border-radius: 999px;
      border: 1px solid var(--border);
      overflow: hidden;
      height: 16px;
      margin-top: 6px;
    }
    .progress-bar-inner {
      height: 100%;
      background: linear-gradient(90deg, var(--accent3), var(--accent2));
      width: 0%;
      transition: width 0.4s ease;
    }
    .progress-label {
      font-size: 0.75rem;
      margin-top: 4px;
      color: var(--muted);
    }
    .status-chip {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      font-size: 0.72rem;
      margin-top: 4px;
    }
    .status-good {
      border-color: var(--accent3);
      color: var(--accent3);
    }
    .status-warn {
      border-color: var(--warning);
      color: var(--warning);
    }
    .status-bad {
      border-color: var(--danger);
      color: var(--danger);
    }
    canvas {
      width: 100% !important;
      max-height: 260px;
    }
    .charts-grid {
      display: grid;
      grid-template-columns: minmax(0,1fr) minmax(0,1fr);
      gap: 12px;
    }
    @media (max-width: 720px) {
      .charts-grid {
        grid-template-columns: minmax(0,1fr);
      }
    }
    .pill-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
    }
    .pill-tag {
      font-size: 0.7rem;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      color: var(--muted);
      background: rgba(255,255,255,0.02);
    }
    .flex-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
    }
    .muted-strong {
      font-size: 0.8rem;
      color: var(--muted);
    }
    .exercise-group {
      margin-top: 8px;
      border-top: 1px dashed var(--border);
      padding-top: 6px;
    }
    .exercise-title {
      font-size: 0.82rem;
      font-weight: 600;
      margin-bottom: 4px;
    }
    .exercise-list {
      display: grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 4px;
      font-size: 0.75rem;
    }
    @media (max-width: 520px) {
      .exercise-list {
        grid-template-columns: minmax(0,1fr);
      }
    }
    .exercise-list label {
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      margin-bottom: 0;
    }
    .exercise-list input[type="checkbox"] {
      width: 14px;
      height: 14px;
    }
    .auth-layout {
      max-width: 420px;
      margin: 40px auto 20px;
    }
    .hidden {
      display: none !important;
    }
    @media (max-width: 480px) {
      h1 {
        font-size: 1.5rem;
      }
      .shell {
        padding: 16px 10px 32px;
      }
      .card {
        padding: 16px 12px;
        border-radius: 14px;
      }
    }
  </style>
</head>
<body>
  <div class="shell">

    <!-- HEADER / HERO -->
    <div class="card">
      <h1>Evolu√ß√£o Dark Premium</h1>
      <p class="subtitle">
        Sua evolu√ß√£o come√ßa aqui. Painel dark, motivacional e focado em <strong>resultado real</strong>,
        com dados por usu√°rio.
      </p>
      <div class="badge-row">
        <span class="badge badge-accent">Login por usu√°rio</span>
        <span class="badge">Gr√°ficos de peso + IMC</span>
        <span class="badge">Frequ√™ncia da academia em destaque</span>
      </div>
      <div class="meta-row">
        <div>
          <div class="meta-label">Dom√≠nio</div>
          <div>projeto.esoares.net.br</div>
        </div>
        <div>
          <div class="meta-label">Mood</div>
          <div>Dark Premium üñ§</div>
        </div>
        <div>
          <div class="meta-label">Motiva√ß√£o</div>
          <div>Const√¢ncia > Motiva√ß√£o do dia</div>
        </div>
      </div>
    </div>

    <!-- AUTH -->
    <div id="authCard" class="card auth-layout">
      <h2>Entrar na sua √°rea</h2>
      <p class="small">
        Use seu e-mail e senha cadastrados. Cada usu√°rio v√™ apenas a pr√≥pria evolu√ß√£o.
      </p>

      <label for="authEmail">E-mail</label>
      <input type="email" id="authEmail" placeholder="voce@exemplo.com" />

      <label for="authPassword" style="margin-top:8px;">Senha</label>
      <input type="password" id="authPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />

      <div class="btn-row">
        <button class="btn-primary" id="loginBtn">Entrar</button>
        <button class="btn-ghost" id="registerBtn">Criar conta</button>
      </div>

      <p id="authMessage" class="small"></p>
    </div>

    <!-- APP PRINCIPAL (mostrado somente logado) -->
    <div id="appArea" class="hidden">

      <!-- PERFIL & METAS -->
      <div class="card">
        <div class="flex-row">
          <div>
            <h2>Perfil & Metas</h2>
            <p class="small">
              Campos mais compactos, sem ocupar metade da gal√°xia. Aqui √© s√≥ o essencial.
            </p>
          </div>
          <div id="userEmailLabel" class="muted-strong"></div>
        </div>

        <div class="form-grid-compact" style="margin-top:10px;">
          <div>
            <label for="nome">Nome de exibi√ß√£o</label>
            <input type="text" id="nome" placeholder="Ex: √âverton" />
          </div>
          <div>
            <label for="sexo">Sexo</label>
            <select id="sexo">
              <option value="">Selecione</option>
              <option value="masc">Masculino</option>
              <option value="fem">Feminino</option>
              <option value="outro">Outro / Prefiro n√£o dizer</option>
            </select>
          </div>
          <div>
            <label for="altura">Altura (cm)</label>
            <input type="number" id="altura" placeholder="Ex: 175" />
          </div>
          <div>
            <label for="metaTreinos">Meta treinos/semana</label>
            <input type="number" id="metaTreinos" placeholder="Ex: 4" />
          </div>
        </div>

        <div class="form-grid-compact" style="margin-top:8px;">
          <div>
            <label for="pesoInicial">Peso inicial (kg)</label>
            <input type="number" step="0.1" id="pesoInicial" placeholder="Ex: 90" />
          </div>
          <div>
            <label for="pesoMeta">Peso meta (kg)</label>
            <input type="number" step="0.1" id="pesoMeta" placeholder="Ex: 75" />
          </div>
          <div>
            <label for="objetivo">Objetivo</label>
            <select id="objetivo">
              <option value="">Selecione</option>
              <option value="emagrecer">Emagrecimento</option>
              <option value="hipertrofia">Hipertrofia</option>
              <option value="saude">Sa√∫de geral</option>
            </select>
          </div>
          <div>
            <label for="dieta">Dieta principal</label>
            <select id="dieta">
              <option value="">Selecione</option>
              <option value="lowcarb">Low carb</option>
              <option value="keto">Cetog√™nica</option>
              <option value="highprotein">High protein</option>
              <option value="flexivel">Flex√≠vel</option>
            </select>
          </div>
        </div>

        <div class="btn-row">
          <button class="btn-primary" id="saveProfileBtn">Salvar perfil & metas</button>
        </div>
        <p id="profileMessage" class="small"></p>
      </div>

      <!-- DASHBOARD: META, PESO, IMC, FREQU√äNCIA -->
      <div class="card">
        <h2>Dashboard de evolu√ß√£o</h2>
        <p class="small">
          Meta de peso, IMC e frequ√™ncia da academia num lugar s√≥. Sem drama, s√≥ progresso.
        </p>

        <!-- Progresso Peso -->
        <div style="margin-top:6px;">
          <div class="flex-row">
            <div class="muted-strong">Progresso da meta de peso</div>
            <div id="pesoResumo" class="small"></div>
          </div>
          <div class="progress-bar-wrap">
            <div id="pesoProgressBar" class="progress-bar-inner"></div>
          </div>
          <div id="pesoMessage" class="progress-label"></div>
        </div>

        <!-- Charts Peso + IMC -->
        <div class="charts-grid" style="margin-top:14px;">
          <div>
            <div class="flex-row">
              <span class="muted-strong">Peso (kg)</span>
              <span id="pesoTendencia" class="status-chip status-good hidden"></span>
            </div>
            <canvas id="pesoChart"></canvas>
          </div>
          <div>
            <div class="flex-row">
              <span class="muted-strong">IMC</span>
              <span id="imcStatus" class="status-chip hidden"></span>
            </div>
            <canvas id="imcChart"></canvas>
          </div>
        </div>

        <!-- Frequ√™ncia academia -->
        <div style="margin-top:16px;">
          <div class="flex-row">
            <div class="muted-strong">Frequ√™ncia da academia (semana atual)</div>
            <div id="freqResumo" class="small"></div>
          </div>
          <div class="progress-bar-wrap">
            <div id="freqProgressBar" class="progress-bar-inner"></div>
          </div>
          <div id="freqMessage" class="progress-label"></div>
        </div>
      </div>

      <!-- CHECK-IN SEMANAL -->
      <div class="card">
        <h2>Check-in semanal</h2>
        <p class="small">
          Preencha 1x por semana. Isso alimenta os gr√°ficos e as mensagens motivacionais.
        </p>

        <div class="form-grid-3" style="margin-top:8px;">
          <div>
            <label for="dataCheckin">Data</label>
            <input type="date" id="dataCheckin" />
          </div>
          <div>
            <label for="pesoAtual">Peso da semana (kg)</label>
            <input type="number" step="0.1" id="pesoAtual" placeholder="Ex: 87.0" />
          </div>
          <div>
            <label for="cintura">Cintura (cm)</label>
            <input type="number" step="0.1" id="cintura" placeholder="Ex: 90" />
          </div>
        </div>

        <div class="form-grid-3" style="margin-top:8px;">
          <div>
            <label for="energia">Energia (1‚Äì10)</label>
            <input type="number" min="1" max="10" id="energia" placeholder="Ex: 8" />
          </div>
          <div>
            <label for="humor">Humor (1‚Äì10)</label>
            <input type="number" min="1" max="10" id="humor" placeholder="Ex: 9" />
          </div>
          <div>
            <label for="sono">Sono (1‚Äì10)</label>
            <input type="number" min="1" max="10" id="sono" placeholder="Ex: 7" />
          </div>
        </div>

        <div style="margin-top:8px;">
          <label for="obs">Observa√ß√µes</label>
          <input type="text" id="obs" placeholder="Ex: mais cardio, menos fome, viagem, etc." />
        </div>

        <div class="btn-row">
          <button class="btn-primary" id="addCheckinBtn">Salvar semana</button>
        </div>
        <p id="checkinMessage" class="small"></p>

        <div class="table-wrap" style="margin-top:12px;">
          <table>
            <thead>
              <tr>
                <th>Data</th>
                <th>Peso</th>
                <th>Cintura</th>
                <th>IMC</th>
                <th>Energia</th>
                <th>Humor</th>
                <th>Sono</th>
                <th>Observa√ß√µes</th>
              </tr>
            </thead>
            <tbody id="historyTableBody"></tbody>
          </table>
        </div>
      </div>

      <!-- TREINOS & FREQU√äNCIA -->
      <div class="card">
        <h2>Treinos da semana</h2>
        <p class="small">
          Marque o que j√° fez. A barra de frequ√™ncia l√° em cima reage a isso e te avisa quando
          a semana est√° ‚Äúmeio Nutella‚Äù de treino.
        </p>

        <div class="exercise-group">
          <div class="exercise-title">Treino A ‚Äì Peito / Tr√≠ceps</div>
          <div class="exercise-list" data-session="A">
            <label><input type="checkbox" data-ex="supino"> Supino reto ‚Äì 3x10</label>
            <label><input type="checkbox" data-ex="inclinado"> Supino inclinado ‚Äì 3x10</label>
            <label><input type="checkbox" data-ex="crucifixo"> Crucifixo ‚Äì 3x12</label>
            <label><input type="checkbox" data-ex="triceps"> Tr√≠ceps corda ‚Äì 3x12</label>
          </div>
        </div>

        <div class="exercise-group">
          <div class="exercise-title">Treino B ‚Äì Costas / B√≠ceps</div>
          <div class="exercise-list" data-session="B">
            <label><input type="checkbox" data-ex="puxada"> Puxada frente ‚Äì 3x10</label>
            <label><input type="checkbox" data-ex="remada"> Remada baixa ‚Äì 3x12</label>
            <label><input type="checkbox" data-ex="serrote"> Remada unilateral ‚Äì 3x10</label>
            <label><input type="checkbox" data-ex="rosca"> Rosca direta ‚Äì 3x12</label>
          </div>
        </div>

        <div class="exercise-group">
          <div class="exercise-title">Treino C ‚Äì Pernas / Gl√∫teos</div>
          <div class="exercise-list" data-session="C">
            <label><input type="checkbox" data-ex="agachamento"> Agachamento ‚Äì 4x8</label>
            <label><input type="checkbox" data-ex="legpress"> Leg press ‚Äì 3x12</label>
            <label><input type="checkbox" data-ex="cadeiraext"> Cadeira extensora ‚Äì 3x15</label>
            <label><input type="checkbox" data-ex="cadeiraflex"> Cadeira flexora ‚Äì 3x15</label>
          </div>
        </div>

        <div class="exercise-group">
          <div class="exercise-title">Treino D ‚Äì Ombro / Core</div>
          <div class="exercise-list" data-session="D">
            <label><input type="checkbox" data-ex="desenvolvimento"> Desenvolvimento ‚Äì 3x10</label>
            <label><input type="checkbox" data-ex="elevacaolateral"> Eleva√ß√£o lateral ‚Äì 3x12</label>
            <label><input type="checkbox" data-ex="prancha"> Prancha ‚Äì 3x30s</label>
            <label><input type="checkbox" data-ex="abdominal"> Abdominal ‚Äì 3x20</label>
          </div>
        </div>

        <div class="btn-row">
          <button class="btn-primary" id="saveTrainingBtn">Salvar treinos da semana</button>
        </div>
        <p id="trainingMessage" class="small"></p>

        <p id="trainingAlerts" class="small" style="margin-top:10px;"></p>
      </div>

      <!-- SUPLEMENTOS & HOR√ÅRIOS -->
      <div class="card">
        <h2>Suplementos & hor√°rios</h2>
        <p class="small">
          Digite o que voc√™ est√° usando (ex: whey, creatina, vitamina D, √¥mega 3). 
          A IA aqui do ‚ÄúDark Premium‚Äù sugere os melhores hor√°rios e usos. üòâ
        </p>

        <label for="suplementosTexto">O que voc√™ est√° tomando?</label>
        <textarea id="suplementosTexto" rows="3" placeholder="Ex: whey, creatina, vitamina D, √¥mega 3, multivitam√≠nico"></textarea>

        <div class="btn-row">
          <button class="btn-primary" id="saveSupplementsBtn">Salvar & sugerir hor√°rios</button>
        </div>

        <div id="supplementsSuggestions" class="small" style="margin-top:10px;"></div>
      </div>

      <!-- SEGURAN√áA & CONTA (L√Å NO FINAL) -->
      <div class="card">
        <h2>Seguran√ßa & conta</h2>
        <p class="small">
          √Årea l√° embaixo, como combinado. Aqui voc√™ pode trocar a senha ou sair da sua conta.
        </p>

        <label for="newPassword">Nova senha</label>
        <input type="password" id="newPassword" placeholder="Digite a nova senha" />

        <div class="btn-row">
          <button class="btn-ghost" id="changePasswordBtn">Trocar senha</button>
          <button class="btn-danger" id="logoutBtn">Sair</button>
        </div>
        <p id="securityMessage" class="small"></p>
      </div>
    </div>
  </div>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Firebase + App -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      signOut,
      updatePassword
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import {
      getFirestore,
      doc,
      getDoc,
      setDoc
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    // --- CONFIG DO SEU PROJETO (o que voc√™ me mandou) ---
    const firebaseConfig = {
      apiKey: "AIzaSyBbz-DjxSv2S2g1qkWca8YpNn3g7C4Oic0",
      authDomain: "evolucao-dark-premium.firebaseapp.com",
      projectId: "evolucao-dark-premium",
      storageBucket: "evolucao-dark-premium.firebasestorage.app",
      messagingSenderId: "1041789751060",
      appId: "1:1041789751060:web:eb2afd0d1a4af526e0fc01"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // --- DOM helpers ---
    const $ = (id) => document.getElementById(id);

    const authCard = $("authCard");
    const appArea = $("appArea");
    const authMessage = $("authMessage");
    const userEmailLabel = $("userEmailLabel");

    let currentUser = null;
    let userData = {
      profile: {},
      checkins: [],
      training: {
        weeks: {},
        metaTreinos: 0
      },
      supplements: {
        texto: ""
      }
    };

    // --- Helpers de semana ---
    function getWeekKey(date = new Date()) {
      const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
      const dayNum = d.getUTCDay() || 7;
      d.setUTCDate(d.getUTCDate() + 4 - dayNum);
      const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
      const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
      return d.getUTCFullYear() + "-W" + weekNo;
    }

    // --- Auth: login / registro / estado ---
    $("loginBtn").addEventListener("click", async () => {
      const email = $("authEmail").value.trim();
      const password = $("authPassword").value;
      authMessage.textContent = "";
      try {
        await signInWithEmailAndPassword(auth, email, password);
        authMessage.textContent = "Login realizado com sucesso.";
      } catch (e) {
        authMessage.textContent = "Erro ao entrar: " + e.message;
      }
    });

    $("registerBtn").addEventListener("click", async () => {
      const email = $("authEmail").value.trim();
      const password = $("authPassword").value;
      authMessage.textContent = "";
      try {
        await createUserWithEmailAndPassword(auth, email, password);
        authMessage.textContent = "Conta criada. Voc√™ j√° est√° logado.";
      } catch (e) {
        authMessage.textContent = "Erro ao criar conta: " + e.message;
      }
    });

    $("logoutBtn").addEventListener("click", async () => {
      await signOut(auth);
    });

    $("changePasswordBtn").addEventListener("click", async () => {
      const newPassword = $("newPassword").value;
      $("securityMessage").textContent = "";
      if (!newPassword || newPassword.length < 6) {
        $("securityMessage").textContent = "A senha deve ter pelo menos 6 caracteres.";
        return;
      }
      try {
        await updatePassword(auth.currentUser, newPassword);
        $("securityMessage").textContent = "Senha alterada com sucesso.";
      } catch (e) {
        $("securityMessage").textContent = "Erro ao trocar senha: " + e.message;
      }
    });

    onAuthStateChanged(auth, async (user) => {
      currentUser = user;
      if (!user) {
        authCard.classList.remove("hidden");
        appArea.classList.add("hidden");
        return;
      }
      authCard.classList.add("hidden");
      appArea.classList.remove("hidden");
      userEmailLabel.textContent = user.email || "";
      await loadUserData();
      fillProfileForm();
      fillSupplements();
      renderAll();
    });

    // --- Firestore: carregar / salvar ---
    async function loadUserData() {
      if (!currentUser) return;
      const ref = doc(db, "users", currentUser.uid);
      const snap = await getDoc(ref);
      if (snap.exists()) {
        userData = {
          profile: snap.data().profile || {},
          checkins: snap.data().checkins || [],
          training: snap.data().training || { weeks: {}, metaTreinos: 0 },
          supplements: snap.data().supplements || { texto: "" }
        };
      } else {
        userData = {
          profile: {},
          checkins: [],
          training: { weeks: {}, metaTreinos: 0 },
          supplements: { texto: "" }
        };
      }
    }

    async function saveUserData() {
      if (!currentUser) return;
      const ref = doc(db, "users", currentUser.uid);
      await setDoc(ref, userData, { merge: true });
    }

    // --- Perfil & metas ---
    function fillProfileForm() {
      const p = userData.profile || {};
      $("nome").value = p.nome || "";
      $("sexo").value = p.sexo || "";
      $("altura").value = p.altura || "";
      $("metaTreinos").value = p.metaTreinos || "";
      $("pesoInicial").value = p.pesoInicial || "";
      $("pesoMeta").value = p.pesoMeta || "";
      $("objetivo").value = p.objetivo || "";
      $("dieta").value = p.dieta || "";
    }

    $("saveProfileBtn").addEventListener("click", async () => {
      const profile = {
        nome: $("nome").value.trim(),
        sexo: $("sexo").value,
        altura: $("altura").value ? parseFloat($("altura").value) : null,
        metaTreinos: $("metaTreinos").value ? parseInt($("metaTreinos").value, 10) : 0,
        pesoInicial: $("pesoInicial").value ? parseFloat($("pesoInicial").value) : null,
        pesoMeta: $("pesoMeta").value ? parseFloat($("pesoMeta").value) : null,
        objetivo: $("objetivo").value,
        dieta: $("dieta").value
      };
      userData.profile = profile;
      // sincroniza metaTreinos no bloco de treino
      userData.training.metaTreinos = profile.metaTreinos || 0;

      try {
        await saveUserData();
        $("profileMessage").textContent = "Perfil salvo com sucesso.";
        renderAll();
      } catch (e) {
        $("profileMessage").textContent = "Erro ao salvar perfil: " + e.message;
      }
    });

    // --- Check-in semanal ---
    $("addCheckinBtn").addEventListener("click", async () => {
      const dataStr = $("dataCheckin").value;
      const pesoStr = $("pesoAtual").value;
      const cinturaStr = $("cintura").value;
      if (!dataStr || !pesoStr) {
        $("checkinMessage").textContent = "Informe pelo menos data e peso.";
        return;
      }
      const altura = userData.profile.altura || null;
      const peso = parseFloat(pesoStr.replace(",", "."));
      const cintura = cinturaStr ? parseFloat(cinturaStr.replace(",", ".")) : null;
      let imc = null;
      if (altura && peso) {
        const h = altura / 100;
        imc = +(peso / (h * h)).toFixed(1);
      }

      const entry = {
        data: dataStr,
        peso,
        cintura,
        imc,
        energia: $("energia").value ? parseInt($("energia").value, 10) : null,
        humor: $("humor").value ? parseInt($("humor").value, 10) : null,
        sono: $("sono").value ? parseInt($("sono").value, 10) : null,
        obs: $("obs").value.trim()
      };

      // se j√° existe check-in nesse dia, substitui
      const existingIndex = userData.checkins.findIndex((c) => c.data === dataStr);
      if (existingIndex >= 0) {
        userData.checkins[existingIndex] = entry;
      } else {
        userData.checkins.push(entry);
      }

      try {
        await saveUserData();
        $("checkinMessage").textContent = "Semana salva com sucesso.";
        renderCheckins();
        renderProgress();
        renderCharts();
      } catch (e) {
        $("checkinMessage").textContent = "Erro ao salvar semana: " + e.message;
      }
    });

    function renderCheckins() {
      const tbody = $("historyTableBody");
      tbody.innerHTML = "";
      const altura = userData.profile.altura || null;
      const sorted = [...userData.checkins].sort((a, b) => (a.data > b.data ? 1 : -1));
      for (const c of sorted) {
        let imcVal = c.imc;
        if (!imcVal && altura && c.peso) {
          const h = altura / 100;
          imcVal = +(c.peso / (h * h)).toFixed(1);
        }
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${c.data}</td>
          <td>${c.peso ?? ""}</td>
          <td>${c.cintura ?? ""}</td>
          <td>${imcVal ?? ""}</td>
          <td>${c.energia ?? ""}</td>
          <td>${c.humor ?? ""}</td>
          <td>${c.sono ?? ""}</td>
          <td>${c.obs ?? ""}</td>
        `;
        tbody.appendChild(tr);
      }
    }

    // --- Barra de progresso de peso + mensagens motivacionais ---
    function renderProgress() {
      const p = userData.profile || {};
      const pesoInicial = p.pesoInicial;
      const pesoMeta = p.pesoMeta;
      if (!pesoInicial || !pesoMeta || userData.checkins.length === 0) {
        $("pesoResumo").textContent = "Defina peso inicial, meta e fa√ßa pelo menos 1 check-in.";
        $("pesoProgressBar").style.width = "0%";
        $("pesoMessage").textContent = "";
        return;
      }
      const sorted = [...userData.checkins].sort((a, b) => (a.data > b.data ? 1 : -1));
      const pesoAtual = sorted[sorted.length - 1].peso;
      if (!pesoAtual) return;

      const totalDelta = pesoInicial - pesoMeta;
      const atualDelta = pesoInicial - pesoAtual;
      let perc = 0;
      if (totalDelta !== 0) {
        perc = (atualDelta / totalDelta) * 100;
        if (perc < 0) perc = 0;
        if (perc > 100) perc = 100;
      }
      $("pesoProgressBar").style.width = perc.toFixed(1) + "%";
      $("pesoResumo").textContent =
        `Inicial: ${pesoInicial} kg ‚Ä¢ Atual: ${pesoAtual} kg ‚Ä¢ Meta: ${pesoMeta} kg`;

      let msg = "";
      if (perc === 0) {
        msg = "Come√ßo √© assim mesmo: arruma a casa, acerta a rotina e o resto vem. üòâ";
      } else if (perc < 30) {
        msg = `Voc√™ j√° saiu do zero! ${perc.toFixed(0)}% da meta. Nada de desistir agora.`;
      } else if (perc < 70) {
        msg = `${perc.toFixed(0)}% da meta! O corpo j√° entendeu o recado, agora √© manter a const√¢ncia. üî•`;
      } else if (perc < 100) {
        msg = `${perc.toFixed(0)}% da meta. T√° na reta final, agora √© jogo mental.`;
      } else {
        msg = "Meta batida! Agora a miss√£o √© manter e talvez pegar uma meta nova. üëè";
      }
      $("pesoMessage").textContent = msg;

      // tend√™ncia de peso
      const pesoTendenciaChip = $("pesoTendencia");
      if (sorted.length >= 2) {
        const pAntes = sorted[sorted.length - 2].peso;
        if (pAntes && pesoAtual) {
          const diff = +(pesoAtual - pAntes).toFixed(1);
          pesoTendenciaChip.classList.remove("hidden", "status-good", "status-bad");
          if (diff < 0) {
            pesoTendenciaChip.classList.add("status-good");
            pesoTendenciaChip.textContent = `Semana boa: -${Math.abs(diff)} kg`;
          } else if (diff > 0) {
            pesoTendenciaChip.classList.add("status-bad");
            pesoTendenciaChip.textContent = `Subiu ${diff} kg (rev√™ dieta/treino)`;
          } else {
            pesoTendenciaChip.textContent = "Peso travado: normal, segue o plano.";
          }
        }
      } else {
        pesoTendenciaChip.classList.add("hidden");
      }
    }

    // --- Frequ√™ncia da academia + alertas de treinos ---
    function renderTrainingFrequency() {
      const meta = userData.training.metaTreinos || userData.profile.metaTreinos || 0;
      const weekKey = getWeekKey();
      const weekData = (userData.training.weeks && userData.training.weeks[weekKey]) || { sessions: {} };

      // conta quantos treinos (A,B,C,D) foram feitos (se todos exerc√≠cios do treino est√£o marcados)
      let realizados = 0;
      ["A", "B", "C", "D"].forEach((sess) => {
        const sessData = weekData.sessions && weekData.sessions[sess];
        if (sessData && Object.values(sessData.exercises || {}).every(Boolean)) {
          realizados += 1;
        }
      });

      $("freqResumo").textContent =
        meta > 0 ? `Realizados: ${realizados} / Meta: ${meta}` : "Defina a meta de treinos/semana no perfil.";

      let perc = 0;
      if (meta > 0) {
        perc = (realizados / meta) * 100;
        if (perc > 100) perc = 100;
      }
      $("freqProgressBar").style.width = perc.toFixed(1) + "%";

      const hoje = new Date();
      const dia = hoje.getDay(); // 0 domingo, 6 s√°bado
      let msg = "";
      if (!meta) {
        msg = "Sem meta definida. Sem meta, qualquer treino serve. üòÖ";
      } else if (perc === 0 && dia >= 3) {
        msg = "Metade da semana, zero treinos. O sof√° t√° ganhando essa disputa. üõãÔ∏è";
      } else if (perc === 0) {
        msg = "Come√ßo da semana: escolhe os dias e j√° combina com voc√™ mesmo.";
      } else if (perc < 50 && dia >= 4) {
        msg = "Frequ√™ncia baixa para a altura da semana. Bora colocar um treino extra?";
      } else if (perc < 100 && dia === 0) {
        msg = "Domingo e meta n√£o batida. √öltima chamada antes de come√ßar tudo outra vez.";
      } else if (perc >= 100) {
        msg = "Meta de treinos da semana batida! Agora √© s√≥ n√£o inventar desculpa nova. üî•";
      } else {
        msg = "T√° indo bem. Mant√©m o ritmo que o shape vem.";
      }
      $("freqMessage").textContent = msg;

      // alertas de exerc√≠cios esquecidos (sei l√°, no fim da semana)
      const alertsEl = $("trainingAlerts");
      alertsEl.textContent = "";
      if (dia >= 5 && meta > 0) {
        const esquecidos = [];
        ["A", "B", "C", "D"].forEach((sess) => {
          const sessData = weekData.sessions && weekData.sessions[sess];
          if (!sessData || !Object.values(sessData.exercises || {}).every(Boolean)) {
            esquecidos.push(sess);
          }
        });
        if (esquecidos.length > 0) {
          alertsEl.textContent =
            "Poss√≠vel treino esquecido essa semana: " +
            esquecidos.map((s) => "Treino " + s).join(", ") +
            ". Se foi por pregui√ßa, n√£o conta pra estat√≠stica oficial. üòÇ";
        }
      }
    }

    // Salvar treinos da semana a partir dos checkboxes
    $("saveTrainingBtn").addEventListener("click", async () => {
      const weekKey = getWeekKey();
      if (!userData.training.weeks) {
        userData.training.weeks = {};
      }
      if (!userData.training.weeks[weekKey]) {
        userData.training.weeks[weekKey] = { sessions: {} };
      }

      const sessions = userData.training.weeks[weekKey].sessions;
      document.querySelectorAll(".exercise-list").forEach((listEl) => {
        const sessName = listEl.getAttribute("data-session");
        const exs = {};
        listEl.querySelectorAll("input[type='checkbox']").forEach((cb) => {
          const key = cb.getAttribute("data-ex");
          exs[key] = cb.checked;
        });
        sessions[sessName] = { exercises: exs };
      });

      try {
        await saveUserData();
        $("trainingMessage").textContent = "Treinos da semana salvos.";
        renderTrainingFrequency();
      } catch (e) {
        $("trainingMessage").textContent = "Erro ao salvar treinos: " + e.message;
      }
    });

    // Preencher checkboxes a partir do banco
    function fillTrainingCheckboxes() {
      const weekKey = getWeekKey();
      const weekData = (userData.training.weeks && userData.training.weeks[weekKey]) || { sessions: {} };
      document.querySelectorAll(".exercise-list").forEach((listEl) => {
        const sessName = listEl.getAttribute("data-session");
        const sessData = weekData.sessions && weekData.sessions[sessName];
        listEl.querySelectorAll("input[type='checkbox']").forEach((cb) => {
          const key = cb.getAttribute("data-ex");
          cb.checked = !!(sessData && sessData.exercises && sessData.exercises[key]);
        });
      });
    }

    // --- Suplementos: sugest√£o m√∫ltipla ---
    function fillSupplements() {
      $("suplementosTexto").value = userData.supplements?.texto || "";
      renderSupplementsSuggestions();
    }

    function renderSupplementsSuggestions() {
      const text = $("suplementosTexto").value.toLowerCase();
      const area = $("supplementsSuggestions");
      if (!text.trim()) {
        area.textContent = "";
        return;
      }

      const map = {
        "whey": "Whey: √≥timo p√≥s-treino ou em lanches com pouco tempo. 1 dose misturada com √°gua ou leite, sem exagerar no resto do dia.",
        "creatina": "Creatina: 3 a 5 g ao dia, qualquer hor√°rio, todos os dias. Const√¢ncia > hor√°rio. Beba √°gua suficiente.",
        "vitamina d": "Vitamina D: geralmente junto de refei√ß√£o com gordura (ex: almo√ßo ou jantar). Siga a dose do m√©dico.",
        "omega 3": "√îmega 3: 1‚Äì2 c√°psulas junto de refei√ß√µes principais, ajuda na inflama√ß√£o e sa√∫de geral.",
        "multivitaminico": "Multivitam√≠nico: 1x ao dia, de prefer√™ncia pela manh√£ com caf√© da manh√£.",
        "vitamina c": "Vitamina C: 500‚Äì1000 mg, normalmente pela manh√£ ou ao redor de treinos intensos.",
        "zinco": "Zinco: muitas vezes √† noite, longe de latic√≠nios para melhor absor√ß√£o.",
        "magnesio": "Magn√©sio: √≥timo √† noite, ajuda relaxar e melhorar a qualidade do sono.",
        "monjaro": "Monjaro: seguir exatamente a orienta√ß√£o do m√©dico, geralmente 1x por semana, sempre anotando efeitos colaterais."
      };

      const encontrados = [];
      for (const chave in map) {
        if (text.includes(chave)) {
          encontrados.push({ nome: chave, dica: map[chave] });
        }
      }

      if (encontrados.length === 0) {
        area.textContent = "N√£o reconheci nenhum suplemento 'cl√°ssico' aqui, mas tudo bem. S√≥ lembra de seguir o m√©dico.";
        return;
      }

      let html = "<strong>Sugest√£o de hor√°rios:</strong><br/>";
      encontrados.forEach((item) => {
        html += "‚Ä¢ " + item.dica + "<br/>";
      });
      html += "<br/><em>Sempre siga a orienta√ß√£o do seu m√©dico. Isso aqui √© organiza√ß√£o, n√£o prescri√ß√£o.</em>";
      area.innerHTML = html;
    }

    $("saveSupplementsBtn").addEventListener("click", async () => {
      userData.supplements = {
        texto: $("suplementosTexto").value
      };
      try {
        await saveUserData();
        renderSupplementsSuggestions();
      } catch (e) {
        $("supplementsSuggestions").textContent = "Erro ao salvar suplementos: " + e.message;
      }
    });

    $("suplementosTexto").addEventListener("blur", renderSupplementsSuggestions);

    // --- Gr√°ficos (peso + IMC) ---
    let pesoChart, imcChart;

    function renderCharts() {
      const altura = userData.profile.altura || null;
      const sorted = [...userData.checkins].sort((a, b) => (a.data > b.data ? 1 : -1));
      const labels = sorted.map((c) => c.data);
      const pesos = sorted.map((c) => c.peso);
      const imcs = sorted.map((c) => {
        if (c.imc) return c.imc;
        if (altura && c.peso) {
          const h = altura / 100;
          return +(c.peso / (h * h)).toFixed(1);
        }
        return null;
      });

      if (pesoChart) pesoChart.destroy();
      if (imcChart) imcChart.destroy();

      const ctxPeso = document.getElementById("pesoChart").getContext("2d");
      const ctxImc = document.getElementById("imcChart").getContext("2d");

      pesoChart = new Chart(ctxPeso, {
        type: "line",
        data: {
          labels,
          datasets: [{
            label: "Peso (kg)",
            data: pesos,
            borderColor: "#4cc9f0",
            backgroundColor: "rgba(76,201,240,0.1)",
            borderWidth: 2,
            tension: 0.35,
            pointRadius: 3
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { labels: { color: "#d0d3ea", usePointStyle: true } } },
          scales: {
            x: { ticks: { color: "#9ba0c2" }, grid: { color: "rgba(255,255,255,0.03)" } },
            y: { ticks: { color: "#9ba0c2" }, grid: { color: "rgba(255,255,255,0.03)" } }
          }
        }
      });

      imcChart = new Chart(ctxImc, {
        type: "line",
        data: {
          labels,
          datasets: [{
            label: "IMC",
            data: imcs,
            borderColor: "#f72585",
            backgroundColor: "rgba(247,37,133,0.1)",
            borderWidth: 2,
            tension: 0.35,
            pointRadius: 3
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { labels: { color: "#d0d3ea", usePointStyle: true } } },
          scales: {
            x: { ticks: { color: "#9ba0c2" }, grid: { color: "rgba(255,255,255,0.03)" } },
            y: { ticks: { color: "#9ba0c2" }, grid: { color: "rgba(255,255,255,0.03)" } }
          }
        }
      });

      // status de IMC atual
      const imcStatus = $("imcStatus");
      imcStatus.classList.add("hidden");
      if (imcs.length > 0) {
        const atual = imcs[imcs.length - 1];
        if (!atual) return;
        imcStatus.classList.remove("hidden", "status-good", "status-warn", "status-bad");
        if (atual < 18.5) {
          imcStatus.classList.add("status-warn");
          imcStatus.textContent = "IMC baixo (" + atual + ")";
        } else if (atual < 25) {
          imcStatus.classList.add("status-good");
          imcStatus.textContent = "IMC ok (" + atual + ")";
        } else if (atual < 30) {
          imcStatus.classList.add("status-warn");
          imcStatus.textContent = "Sobrepeso (" + atual + ")";
        } else {
          imcStatus.classList.add("status-bad");
          imcStatus.textContent = "Obesidade (" + atual + ")";
        }
      }
    }

    function renderAll() {
      renderCheckins();
      renderProgress();
      fillTrainingCheckboxes();
      renderTrainingFrequency();
      renderCharts();
    }
  </script>
</body>
</html>
