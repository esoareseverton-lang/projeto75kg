<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Sua evolu√ß√£o come√ßa aqui - Dark Premium</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0b0c10;
      --card: #12151f;
      --accent: #4cc9f0;
      --accent2: #f72585;
      --text: #f5f5f5;
      --muted: #8a8fa3;
      --border: #222533;
    }
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    body {
      margin: 0;
      background: radial-gradient(circle at top, #141b2d, #05060a);
      color: var(--text);
      min-height: 100vh;
    }
    .shell {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px 12px 40px;
    }
    .card {
      background: linear-gradient(145deg, #111521, #090b12);
      border-radius: 18px;
      padding: 18px 16px;
      border: 1px solid var(--border);
      box-shadow: 0 18px 55px rgba(0,0,0,0.6);
      margin-bottom: 18px;
    }
    h1, h2, h3 {
      margin: 0 0 8px;
    }
    h1 {
      font-size: 1.9rem;
      letter-spacing: 0.05em;
      text-transform: uppercase;
    }
    h2 {
      font-size: 1.2rem;
    }
    .tagline {
      margin-top: 8px;
      font-size: 0.95rem;
      color: var(--muted);
    }
    .badge-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 6px;
    }
    .badge {
      font-size: 0.75rem;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      color: var(--muted);
    }
    .badge-accent {
      border-color: var(--accent);
      color: var(--accent);
    }
    .meta-row {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      margin-top: 10px;
      font-size: 0.85rem;
      color: var(--muted);
    }
    .meta-label {
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-size: 0.7rem;
      color: #6b7086;
    }
    .grid {
      display: grid;
      grid-template-columns: minmax(0, 1.4fr) minmax(0, 1.2fr);
      gap: 16px;
    }
    @media (max-width: 960px) {
      .grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }
    label {
      display: block;
      font-size: 0.8rem;
      margin-bottom: 4px;
      color: var(--muted);
    }
    input, select, textarea {
      width: 100%;
      padding: 9px 11px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #070910;
      color: var(--text);
      font-size: 0.9rem;
      outline: none;
    }
    textarea {
      resize: vertical;
      min-height: 60px;
    }
    input:focus, select:focus, textarea:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(76,201,240,0.3);
    }
    .form-grid-2 {
      display: grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 10px;
    }
    .form-grid-3 {
      display: grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap: 10px;
    }
    @media (max-width: 720px) {
      .form-grid-2, .form-grid-3 {
        grid-template-columns: minmax(0,1fr);
      }
    }
    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 12px;
    }
    button {
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 0.85rem;
      padding: 11px 18px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      font-weight: 500;
      letter-spacing: 0.04em;
      text-transform: uppercase;
    }
    .btn-primary {
      background: linear-gradient(135deg, var(--accent), #4895ef);
      color: #020308;
      box-shadow: 0 12px 30px rgba(72,149,239,0.45);
    }
    .btn-ghost {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--muted);
    }
    .btn-danger {
      background: linear-gradient(135deg, #f72585, #b5179e);
      color: #020308;
    }
    @media (max-width: 600px) {
      .btn-row {
        flex-direction: column;
      }
      .btn-primary, .btn-ghost, .btn-danger {
        width: 100%;
      }
    }
    .small {
      font-size: 0.75rem;
      color: var(--muted);
      margin-top: 4px;
    }
    .pill {
      padding: 2px 7px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.12);
      font-size: 0.7rem;
      color: var(--muted);
    }
    .table-wrap {
      overflow-x: auto;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: #05060b;
      -webkit-overflow-scrolling: touch;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
      min-width: 620px;
    }
    thead {
      background: linear-gradient(90deg, #101320, #15192a);
    }
    th, td {
      padding: 8px 10px;
      text-align: left;
      white-space: nowrap;
    }
    th {
      font-weight: 600;
      font-size: 0.75rem;
      color: #c4c7de;
      border-bottom: 1px solid var(--border);
    }
    tbody tr:nth-child(even) {
      background: rgba(255,255,255,0.015);
    }
    tbody tr:hover {
      background: rgba(76,201,240,0.06);
    }
    canvas {
      width: 100% !important;
      height: 260px !important;
    }
    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 10px;
    }
    .topbar-user {
      font-size: 0.85rem;
      color: var(--muted);
    }
    .hidden {
      display: none !important;
    }
    .motivation {
      margin-top: 8px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px dashed rgba(76,201,240,0.3);
      font-size: 0.8rem;
    }
    .motivation-emoji {
      margin-right: 6px;
    }
    .chips-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
    }
    .chip {
      font-size: 0.7rem;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      color: var(--muted);
      background: rgba(255,255,255,0.02);
    }
    iframe {
      border-radius: 12px;
      border: 1px solid var(--border);
      max-width: 100%;
    }
    .auth-toggle {
      text-align: center;
      margin-top: 10px;
      font-size: 0.8rem;
    }
    .auth-toggle button {
      text-transform: none;
      font-size: 0.8rem;
      padding: 4px 8px;
    }
    .error-text {
      color: #ff6b6b;
      font-size: 0.75rem;
      margin-top: 6px;
    }
    .success-text {
      color: #4cc9f0;
      font-size: 0.75rem;
      margin-top: 6px;
    }
  </style>
</head>
<body>
  <div class="shell">

    <!-- AUTENTICA√á√ÉO -->
    <div id="authCard" class="card">
      <h1>Sua evolu√ß√£o come√ßa aqui</h1>
      <p class="tagline">
        Crie sua conta ou entre para acessar seu painel Dark Premium.
      </p>

      <div class="form-grid-2" style="margin-top:10px;">
        <div id="authNameGroup">
          <label for="authName">Nome</label>
          <input id="authName" type="text" placeholder="Como quer aparecer no painel" />
        </div>
        <div>
          <label for="authEmail">E-mail</label>
          <input id="authEmail" type="email" placeholder="voce@exemplo.com" />
        </div>
      </div>

      <div class="form-grid-2" style="margin-top:10px;">
        <div>
          <label for="authPassword">Senha</label>
          <input id="authPassword" type="password" placeholder="M√≠nimo 6 caracteres" />
        </div>
        <div id="authPasswordConfirmGroup">
          <label for="authPasswordConfirm">Confirmar senha</label>
          <input id="authPasswordConfirm" type="password" placeholder="Repita a senha" />
        </div>
      </div>

      <div class="btn-row">
        <button id="authPrimaryBtn" class="btn-primary">Criar conta</button>
      </div>
      <div id="authMessage" class="error-text"></div>

      <div class="auth-toggle">
        <span id="authToggleText">J√° tem conta?</span>
        <button id="authToggleBtn" class="btn-ghost">Entrar</button>
      </div>
    </div>

    <!-- APP -->
    <div id="app" class="hidden">

      <!-- HEADER -->
      <div class="card">
        <div class="topbar">
          <div>
            <h1>Sua evolu√ß√£o come√ßa aqui</h1>
            <p class="tagline">
              Painel multiusu√°rio para acompanhar metas, treinos, dieta e IMC ‚Äî com um toque de humor.
            </p>
            <div class="badge-row">
              <span class="badge badge-accent">Dark Premium</span>
              <span class="badge">Dom√≠nio: esoares.net.br</span>
              <span class="badge" id="goalBadge">Objetivo: personalizado</span>
            </div>
          </div>
          <div style="text-align:right;min-width:140px;">
            <div class="topbar-user" id="topbarUser">Carregando‚Ä¶</div>
            <button id="logoutBtn" class="btn-ghost" style="margin-top:6px;">Sair</button>
          </div>
        </div>
        <div id="motivationBox" class="motivation">
          <span class="motivation-emoji" id="motivationEmoji">üöÄ</span>
          <span id="motivationText">Bem-vindo(a)! Comece preenchendo seu perfil e a semana 1.</span>
        </div>
      </div>

      <!-- PERFIL & METAS -->
      <div class="grid">
        <div class="card">
          <h2>Seu perfil & metas</h2>
          <p class="small">
            Esses dados s√£o a base para c√°lculos de IMC, metas e recomenda√ß√µes.
          </p>
          <div class="form-grid-2" style="margin-top:10px;">
            <div>
              <label for="profileName">Nome</label>
              <input id="profileName" type="text" placeholder="Seu nome" />
            </div>
            <div>
              <label for="profileGender">Sexo</label>
              <select id="profileGender">
                <option value="">Selecione‚Ä¶</option>
                <option value="M">Masculino</option>
                <option value="F">Feminino</option>
                <option value="O">Outro / Prefiro n√£o dizer</option>
              </select>
            </div>
          </div>

          <div class="form-grid-3" style="margin-top:10px;">
            <div>
              <label for="heightCm">Altura (cm)</label>
              <input id="heightCm" type="number" step="0.1" placeholder="Ex: 175" />
            </div>
            <div>
              <label for="startWeight">Peso inicial (kg)</label>
              <input id="startWeight" type="number" step="0.1" placeholder="Ex: 92.5" />
            </div>
            <div>
              <label for="goalWeight">Meta de peso (kg)</label>
              <input id="goalWeight" type="number" step="0.1" placeholder="Ex: 78.0" />
            </div>
          </div>

          <div class="form-grid-2" style="margin-top:10px;">
            <div>
              <label for="goalType">Objetivo principal</label>
              <select id="goalType">
                <option value="">Selecione‚Ä¶</option>
                <option value="emagrecimento">Emagrecimento</option>
                <option value="hipertrofia">Hipertrofia</option>
                <option value="recomposicao">Recomposi√ß√£o corporal</option>
                <option value="saude">Sa√∫de geral / bem-estar</option>
              </select>
            </div>
            <div>
              <label for="dietType">Tipo de dieta</label>
              <select id="dietType">
                <option value="">Selecione‚Ä¶</option>
                <option value="lowcarb">Low carb</option>
                <option value="highprotein">High protein</option>
                <option value="hipercalorica">Hipercal√≥rica (bulking)</option>
                <option value="mediterranea">Mediterr√¢nea</option>
              </select>
            </div>
          </div>

          <div style="margin-top:10px;">
            <label for="supplementsUser">O que voc√™ toma hoje? (suplementos / vitaminas)</label>
            <textarea id="supplementsUser" placeholder="Ex: whey, creatina, vitamina D, magn√©sio‚Ä¶"></textarea>
          </div>

          <div class="btn-row">
            <button id="saveProfileBtn" class="btn-primary">Salvar perfil</button>
          </div>
          <div id="profileMessage" class="success-text"></div>
        </div>

        <div class="card">
          <h2>Resumo r√°pido & IMC</h2>
          <div class="small" id="bmiSummary">
            Preencha primeiro seu peso inicial, meta e altura.
          </div>
          <div class="chips-row" id="chipsRow" style="margin-top:10px;">
            <!-- preenchido via JS -->
          </div>
          <div class="small" style="margin-top:10px;">
            IMC √© apenas um indicador. N√£o substitui avalia√ß√£o profissional ‚Äî mas ajuda a acompanhar a curva.
          </div>
        </div>
      </div>

      <!-- PROGRESSO SEMANAL + GR√ÅFICOS -->
      <div class="grid">
        <div class="card">
          <h2>Registrar semana</h2>
          <p class="small">
            Preencha e clique em <strong>Salvar semana</strong>. Os dados ficam vinculados ao seu usu√°rio.
          </p>

          <div style="margin-top:10px;">
            <label for="week">Semana</label>
            <select id="week">
              <option value="">Selecione‚Ä¶</option>
              <option value="1">Semana 1</option>
              <option value="2">Semana 2</option>
              <option value="3">Semana 3</option>
              <option value="4">Semana 4</option>
              <option value="5">Semana 5</option>
              <option value="6">Semana 6</option>
              <option value="7">Semana 7</option>
              <option value="8">Semana 8</option>
              <option value="9">Semana 9</option>
              <option value="10">Semana 10</option>
              <option value="11">Semana 11</option>
              <option value="12">Semana 12</option>
            </select>
          </div>

          <div class="form-grid-3" style="margin-top:10px;">
            <div>
              <label for="peso">Peso da semana (kg)</label>
              <input id="peso" type="number" step="0.1" placeholder="Ex: 87.0" />
            </div>
            <div>
              <label for="cintura">Cintura (cm)</label>
              <input id="cintura" type="number" step="0.1" placeholder="Ex: 90" />
            </div>
            <div>
              <label for="energia">Energia (1‚Äì10)</label>
              <input id="energia" type="number" min="1" max="10" placeholder="Ex: 8" />
            </div>
            <div>
              <label for="humor">Humor (1‚Äì10)</label>
              <input id="humor" type="number" min="1" max="10" placeholder="Ex: 9" />
            </div>
            <div>
              <label for="sono">Sono (1‚Äì10)</label>
              <input id="sono" type="number" min="1" max="10" placeholder="Ex: 7" />
            </div>
          </div>

          <div style="margin-top:10px;">
            <label for="obs">Observa√ß√µes da semana</label>
            <input id="obs" type="text" placeholder="Ex: mais cardio, menos fome, viagem, etc." />
          </div>

          <div class="btn-row">
            <button id="saveWeekBtn" class="btn-primary">Salvar semana</button>
            <button id="clearWeeksBtn" class="btn-danger">Apagar todas as semanas</button>
          </div>
          <div id="weekMessage" class="success-text"></div>
        </div>

        <div class="card">
          <h2>Gr√°ficos de progresso</h2>
          <p class="small">
            Peso x cintura e IMC por semana. A ideia √© ver a <strong>tend√™ncia</strong>, n√£o sofrer com cada oscila√ß√£o.
          </p>
          <div style="margin-top:10px;">
            <canvas id="weightChart"></canvas>
          </div>
          <div style="margin-top:16px;">
            <canvas id="bmiChart"></canvas>
          </div>
        </div>
      </div>

      <!-- HIST√ìRICO -->
      <div class="card">
        <h2>Hist√≥rico completo</h2>
        <p class="small">
          Todas as semanas registradas para este usu√°rio. Role para o lado no celular.
        </p>
        <div class="table-wrap">
          <table id="historyTable">
            <thead>
              <tr>
                <th>Semana</th>
                <th>Peso (kg)</th>
                <th>Cintura (cm)</th>
                <th>IMC</th>
                <th>Energia</th>
                <th>Humor</th>
                <th>Sono</th>
                <th>Observa√ß√µes</th>
              </tr>
            </thead>
            <tbody>
              <!-- preenchido via JS -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- RECOMENDA√á√ïES DE TREINO / DIETA / SUPLEMENTOS -->
      <div class="card">
        <h2>Recomenda√ß√µes inteligentes (fixas no front)</h2>
        <p class="small">
          Baseado no <strong>sexo, objetivo e tipo de dieta</strong> que voc√™ salvou no perfil.
          Isso aqui n√£o √© consulta m√©dica nem nutri, √© um atalho organizado para voc√™ discutir com seu profissional.
        </p>

        <h3 style="margin-top:10px;">Sugest√£o de treino por objetivo</h3>
        <div id="workoutSuggestions" class="small">
          Salve primeiro seu objetivo no perfil.
        </div>

        <h3 style="margin-top:14px;">Dieta escolhida: alimentos recomendados x evitar</h3>
        <div id="dietSuggestions" class="small">
          Selecione e salve um tipo de dieta no perfil.
        </div>

        <h3 style="margin-top:14px;">Suplementos & vitaminas ‚Äì organiza√ß√£o de hor√°rios</h3>
        <div id="supplementSuggestions" class="small">
          Preencha o que voc√™ j√° usa no campo de suplementos. Aqui v√£o sugest√µes gerais de hor√°rio para low carb / high protein:
          <ul>
            <li><strong>Manh√£:</strong> whey / prote√≠na, creatina, polivitam√≠nico, vitamina C.</li>
            <li><strong>Pr√©/ p√≥s-treino:</strong> whey ou refei√ß√£o proteica forte + creatina + eletr√≥litos se suar muito.</li>
            <li><strong>Noite:</strong> magn√©sio, vitamina D (se indicado), √¥mega-3 com refei√ß√£o.</li>
          </ul>
          Sempre alinhe com seu m√©dico ou nutricionista.
        </div>

        <h3 style="margin-top:14px;">V√≠deos de refer√™ncia ‚Äì execu√ß√£o dos exerc√≠cios</h3>
        <p class="small">
          Selecionamos 2 playlists gerais. Use como base e salve seus favoritos:
        </p>
        <div class="form-grid-2" style="margin-top:8px;">
          <div>
            <p class="small"><strong>Full body / iniciante</strong></p>
            <iframe width="100%" height="200" src="https://www.youtube.com/embed/videoseries?list=PLv2eAq3qEev-beginner-fullbody"
              title="Treino iniciante full body" allowfullscreen loading="lazy"></iframe>
          </div>
          <div>
            <p class="small"><strong>Foco em pernas / gl√∫teos</strong></p>
            <iframe width="100%" height="200" src="https://www.youtube.com/embed/videoseries?list=PLv2eAq3qEev-glute-leg"
              title="Treino de pernas e gl√∫teos" allowfullscreen loading="lazy"></iframe>
          </div>
        </div>
        <p class="small" style="margin-top:8px;">
          Se quiser, troque as URLs das playlists pelos canais que voc√™ mais confia.
        </p>
      </div>

    </div>
  </div>

  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Firebase SDK (modular v9+) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      signOut,
      updateProfile,
      updatePassword
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import {
      getFirestore,
      doc,
      setDoc,
      getDoc,
      collection,
      getDocs,
      deleteDoc
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    // --- CONFIG DO SEU PROJETO FIREBASE ---
    const firebaseConfig = {
      apiKey: "AIzaSyBbz-DjxSv2S2g1qkWca8YpNn3g7C4Oic0",
      authDomain: "evolucao-dark-premium.firebaseapp.com",
      projectId: "evolucao-dark-premium",
      storageBucket: "evolucao-dark-premium.firebasestorage.app",
      messagingSenderId: "1041789751060",
      appId: "1:1041789751060:web:eb2afd0d1a4af526e0fc01"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // --- ELEMENTOS DOM ---
    const authCard = document.getElementById("authCard");
    const appDiv = document.getElementById("app");

    const authNameGroup = document.getElementById("authNameGroup");
    const authPasswordConfirmGroup = document.getElementById("authPasswordConfirmGroup");
    const authName = document.getElementById("authName");
    const authEmail = document.getElementById("authEmail");
    const authPassword = document.getElementById("authPassword");
    const authPasswordConfirm = document.getElementById("authPasswordConfirm");
    const authPrimaryBtn = document.getElementById("authPrimaryBtn");
    const authToggleBtn = document.getElementById("authToggleBtn");
    const authToggleText = document.getElementById("authToggleText");
    const authMessage = document.getElementById("authMessage");

    const logoutBtn = document.getElementById("logoutBtn");
    const topbarUser = document.getElementById("topbarUser");
    const goalBadge = document.getElementById("goalBadge");
    const motivationBox = document.getElementById("motivationBox");
    const motivationEmoji = document.getElementById("motivationEmoji");
    const motivationText = document.getElementById("motivationText");

    const profileName = document.getElementById("profileName");
    const profileGender = document.getElementById("profileGender");
    const heightCm = document.getElementById("heightCm");
    const startWeight = document.getElementById("startWeight");
    const goalWeight = document.getElementById("goalWeight");
    const goalType = document.getElementById("goalType");
    const dietType = document.getElementById("dietType");
    const supplementsUser = document.getElementById("supplementsUser");
    const saveProfileBtn = document.getElementById("saveProfileBtn");
    const profileMessage = document.getElementById("profileMessage");
    const bmiSummary = document.getElementById("bmiSummary");
    const chipsRow = document.getElementById("chipsRow");

    const weekSelect = document.getElementById("week");
    const pesoInput = document.getElementById("peso");
    const cinturaInput = document.getElementById("cintura");
    const energiaInput = document.getElementById("energia");
    const humorInput = document.getElementById("humor");
    const sonoInput = document.getElementById("sono");
    const obsInput = document.getElementById("obs");
    const saveWeekBtn = document.getElementById("saveWeekBtn");
    const clearWeeksBtn = document.getElementById("clearWeeksBtn");
    const weekMessage = document.getElementById("weekMessage");
    const historyTableBody = document.querySelector("#historyTable tbody");

    const workoutSuggestions = document.getElementById("workoutSuggestions");
    const dietSuggestions = document.getElementById("dietSuggestions");

    const weightChartCanvas = document.getElementById("weightChart");
    const bmiChartCanvas = document.getElementById("bmiChart");

    let currentUser = null;
    let weightChart = null;
    let bmiChart = null;
    let weeksData = [];

    // --- MODO AUTH: cadastro x login ---
    let isLoginMode = false;

    function setAuthMode(loginMode) {
      isLoginMode = loginMode;
      if (loginMode) {
        authNameGroup.classList.add("hidden");
        authPasswordConfirmGroup.classList.add("hidden");
        authPrimaryBtn.textContent = "Entrar";
        authToggleText.textContent = "Ainda n√£o tem conta?";
        authToggleBtn.textContent = "Criar conta";
      } else {
        authNameGroup.classList.remove("hidden");
        authPasswordConfirmGroup.classList.remove("hidden");
        authPrimaryBtn.textContent = "Criar conta";
        authToggleText.textContent = "J√° tem conta?";
        authToggleBtn.textContent = "Entrar";
      }
      authMessage.textContent = "";
    }

    authToggleBtn.addEventListener("click", () => {
      setAuthMode(!isLoginMode);
    });

    authPrimaryBtn.addEventListener("click", async () => {
      authMessage.textContent = "";
      try {
        const email = authEmail.value.trim();
        const password = authPassword.value;
        if (!email || !password) {
          authMessage.textContent = "Preencha e-mail e senha.";
          return;
        }

        if (isLoginMode) {
          await signInWithEmailAndPassword(auth, email, password);
        } else {
          const name = authName.value.trim();
          const confirm = authPasswordConfirm.value;
          if (!name) {
            authMessage.textContent = "Informe seu nome.";
            return;
          }
          if (password !== confirm) {
            authMessage.textContent = "As senhas n√£o coincidem.";
            return;
          }
          const cred = await createUserWithEmailAndPassword(auth, email, password);
          if (cred.user) {
            await updateProfile(cred.user, { displayName: name });
            // cria perfil inicial no Firestore
            await setDoc(doc(db, "profiles", cred.user.uid), {
              name,
              gender: "",
              heightCm: null,
              startWeight: null,
              goalWeight: null,
              goalType: "",
              dietType: "",
              supplementsUser: "",
              createdAt: new Date().toISOString()
            });
          }
        }
      } catch (err) {
        console.error(err);
        authMessage.textContent = "Erro: " + (err.message || "n√£o foi poss√≠vel autenticar.");
      }
    });

    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
    });

    // --- OBSERVA MUDAN√áA DE LOGIN ---
    onAuthStateChanged(auth, async (user) => {
      currentUser = user;
      if (!user) {
        authCard.classList.remove("hidden");
        appDiv.classList.add("hidden");
        topbarUser.textContent = "";
        return;
      }
      authCard.classList.add("hidden");
      appDiv.classList.remove("hidden");
      topbarUser.textContent = user.email || "Usu√°rio logado";

      await loadProfile(user.uid);
      await loadWeeks(user.uid);
    });

    // --- PERFIL ---
    async function loadProfile(uid) {
      profileMessage.textContent = "";
      const ref = doc(db, "profiles", uid);
      const snap = await getDoc(ref);
      let data = null;
      if (snap.exists()) {
        data = snap.data();
      } else {
        data = {};
      }

      profileName.value = data.name || (auth.currentUser?.displayName || "");
      profileGender.value = data.gender || "";
      heightCm.value = data.heightCm ?? "";
      startWeight.value = data.startWeight ?? "";
      goalWeight.value = data.goalWeight ?? "";
      goalType.value = data.goalType || "";
      dietType.value = data.dietType || "";
      supplementsUser.value = data.supplementsUser || "";

      updateGoalBadge();
      updateBmiSummary();
      updateRecommendations();
    }

    async function saveProfile() {
      if (!currentUser) return;
      const uid = currentUser.uid;
      const ref = doc(db, "profiles", uid);

      const name = profileName.value.trim();
      const gender = profileGender.value;
      const h = heightCm.value ? parseFloat(heightCm.value.replace(",", ".")) : null;
      const sw = startWeight.value ? parseFloat(startWeight.value.replace(",", ".")) : null;
      const gw = goalWeight.value ? parseFloat(goalWeight.value.replace(",", ".")) : null;
      const gType = goalType.value;
      const dType = dietType.value;
      const supp = supplementsUser.value.trim();

      await setDoc(ref, {
        name,
        gender,
        heightCm: h,
        startWeight: sw,
        goalWeight: gw,
        goalType: gType,
        dietType: dType,
        supplementsUser: supp,
        updatedAt: new Date().toISOString()
      }, { merge: true });

      if (name && currentUser.displayName !== name) {
        await updateProfile(currentUser, { displayName: name });
      }

      profileMessage.textContent = "Perfil salvo com sucesso.";
      setTimeout(() => { profileMessage.textContent = ""; }, 3000);

      updateGoalBadge();
      updateBmiSummary();
      updateRecommendations();
      updateMotivation();
    }

    saveProfileBtn.addEventListener("click", () => {
      saveProfile().catch(err => {
        console.error(err);
        profileMessage.textContent = "Erro ao salvar perfil.";
      });
    });

    function updateGoalBadge() {
      const gw = parseFloat(goalWeight.value.replace(",", "."));
      if (!isNaN(gw)) {
        goalBadge.textContent = "Objetivo: " + gw.toFixed(1) + " kg";
      } else {
        goalBadge.textContent = "Objetivo: personalizado";
      }
    }

    function bmiFromWeight(weight, heightCmValue) {
      if (!weight || !heightCmValue) return null;
      const hM = heightCmValue / 100;
      if (!hM) return null;
      return weight / (hM * hM);
    }

    function bmiLabel(bmi) {
      if (!bmi) return "";
      if (bmi < 18.5) return "Abaixo do peso";
      if (bmi < 25) return "Faixa saud√°vel";
      if (bmi < 30) return "Sobrepeso";
      return "Obesidade";
    }

    function updateBmiSummary() {
      const h = heightCm.value ? parseFloat(heightCm.value.replace(",", ".")) : null;
      const sw = startWeight.value ? parseFloat(startWeight.value.replace(",", ".")) : null;
      const gw = goalWeight.value ? parseFloat(goalWeight.value.replace(",", ".")) : null;

      const bmiStart = sw ? bmiFromWeight(sw, h) : null;
      const bmiGoal = gw ? bmiFromWeight(gw, h) : null;

      let html = "";
      const chips = [];

      if (bmiStart) {
        html += `IMC inicial aproximado: <strong>${bmiStart.toFixed(1)}</strong> (${bmiLabel(bmiStart)}).<br/>`;
        chips.push(`IMC inicial: ${bmiStart.toFixed(1)}`);
      }
      if (bmiGoal) {
        html += `IMC na meta: <strong>${bmiGoal.toFixed(1)}</strong> (${bmiLabel(bmiGoal)}).<br/>`;
        chips.push(`IMC meta: ${bmiGoal.toFixed(1)}`);
      }
      if (!html) {
        html = "Preencha altura, peso inicial e meta para ver o IMC.";
      }

      bmiSummary.innerHTML = html;
      chipsRow.innerHTML = "";
      chips.forEach(text => {
        const span = document.createElement("span");
        span.className = "chip";
        span.textContent = text;
        chipsRow.appendChild(span);
      });
    }

    // --- SEMANAS / PROGRESSO ---
    async function loadWeeks(uid) {
      weeksData = [];
      historyTableBody.innerHTML = "";

      const colRef = collection(db, "users", uid, "weeks");
      const snap = await getDocs(colRef);
      snap.forEach(docSnap => {
        const d = docSnap.data();
        weeksData.push(d);
      });

      weeksData.sort((a, b) => (a.week || 0) - (b.week || 0));
      renderWeeksTable();
      renderCharts();
      updateMotivation();
    }

    function renderWeeksTable() {
      historyTableBody.innerHTML = "";
      const h = heightCm.value ? parseFloat(heightCm.value.replace(",", ".")) : null;

      weeksData.forEach(row => {
        const tr = document.createElement("tr");
        const bmi = row.bmi || (row.weight && h ? bmiFromWeight(row.weight, h) : null);

        tr.innerHTML = `
          <td><span class="pill">Semana ${row.week}</span></td>
          <td>${row.weight ?? ""}</td>
          <td>${row.waist ?? ""}</td>
          <td>${bmi ? bmi.toFixed(1) : ""}</td>
          <td>${row.energy ?? ""}</td>
          <td>${row.mood ?? ""}</td>
          <td>${row.sleep ?? ""}</td>
          <td>${row.notes ?? ""}</td>
        `;
        historyTableBody.appendChild(tr);
      });
    }

    function renderCharts() {
      const h = heightCm.value ? parseFloat(heightCm.value.replace(",", ".")) : null;
      const sorted = [...weeksData].sort((a, b) => (a.week || 0) - (b.week || 0));

      const labels = sorted.map(d => "S" + d.week);
      const weights = sorted.map(d => d.weight ?? null);
      const waists = sorted.map(d => d.waist ?? null);
      const bmis = sorted.map(d => {
        if (d.bmi) return d.bmi;
        if (d.weight && h) return bmiFromWeight(d.weight, h);
        return null;
      });

      if (weightChart) weightChart.destroy();
      if (bmiChart) bmiChart.destroy();

      const ctxW = weightChartCanvas.getContext("2d");
      const ctxB = bmiChartCanvas.getContext("2d");

      weightChart = new Chart(ctxW, {
        type: "line",
        data: {
          labels,
          datasets: [
            {
              label: "Peso (kg)",
              data: weights,
              borderColor: "#4cc9f0",
              backgroundColor: "rgba(76,201,240,0.1)",
              borderWidth: 2,
              tension: 0.35,
              pointRadius: 3
            },
            {
              label: "Cintura (cm)",
              data: waists,
              borderColor: "#f72585",
              backgroundColor: "rgba(247,37,133,0.1)",
              borderWidth: 2,
              tension: 0.35,
              pointRadius: 3
            }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { labels: { color: "#d0d3ea", usePointStyle: true } }
          },
          scales: {
            x: {
              ticks: { color: "#9ba0c2" },
              grid: { color: "rgba(255,255,255,0.03)" }
            },
            y: {
              ticks: { color: "#9ba0c2" },
              grid: { color: "rgba(255,255,255,0.03)" }
            }
          }
        }
      });

      bmiChart = new Chart(ctxB, {
        type: "line",
        data: {
          labels,
          datasets: [
            {
              label: "IMC",
              data: bmis,
              borderColor: "#ffb703",
              backgroundColor: "rgba(255,183,3,0.1)",
              borderWidth: 2,
              tension: 0.35,
              pointRadius: 3
            }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { labels: { color: "#d0d3ea", usePointStyle: true } }
          },
          scales: {
            x: {
              ticks: { color: "#9ba0c2" },
              grid: { color: "rgba(255,255,255,0.03)" }
            },
            y: {
              ticks: { color: "#9ba0c2" },
              grid: { color: "rgba(255,255,255,0.03)" }
            }
          }
        }
      });
    }

    async function saveWeek() {
      if (!currentUser) return;
      const uid = currentUser.uid;

      const weekVal = parseInt(weekSelect.value, 10);
      if (!weekVal || isNaN(weekVal)) {
        weekMessage.textContent = "Selecione a semana.";
        return;
      }

      const pesoVal = pesoInput.value ? parseFloat(pesoInput.value.replace(",", ".")) : null;
      if (!pesoVal) {
        weekMessage.textContent = "Informe o peso da semana.";
        return;
      }

      const cinturaVal = cinturaInput.value ? parseFloat(cinturaInput.value.replace(",", ".")) : null;
      const energiaVal = energiaInput.value ? parseInt(energiaInput.value, 10) : null;
      const humorVal = humorInput.value ? parseInt(humorInput.value, 10) : null;
      const sonoVal = sonoInput.value ? parseInt(sonoInput.value, 10) : null;
      const obsVal = obsInput.value.trim();
      const h = heightCm.value ? parseFloat(heightCm.value.replace(",", ".")) : null;
      const bmi = h ? bmiFromWeight(pesoVal, h) : null;

      const weekRef = doc(db, "users", uid, "weeks", "week-" + weekVal);
      await setDoc(weekRef, {
        week: weekVal,
        weight: pesoVal,
        waist: cinturaVal,
        energy: energiaVal,
        mood: humorVal,
        sleep: sonoVal,
        notes: obsVal,
        bmi: bmi,
        updatedAt: new Date().toISOString()
      }, { merge: true });

      weekMessage.textContent = "Semana salva com sucesso.";
      setTimeout(() => { weekMessage.textContent = ""; }, 3000);

      await loadWeeks(uid);

      // mini reset
      obsInput.value = "";
    }

    saveWeekBtn.addEventListener("click", () => {
      saveWeek().catch(err => {
        console.error(err);
        weekMessage.textContent = "Erro ao salvar semana.";
      });
    });

    clearWeeksBtn.addEventListener("click", async () => {
      if (!currentUser) return;
      if (!confirm("Tem certeza que deseja apagar TODAS as semanas deste usu√°rio?")) return;
      const uid = currentUser.uid;
      const colRef = collection(db, "users", uid, "weeks");
      const snap = await getDocs(colRef);
      const promises = [];
      snap.forEach(docSnap => {
        promises.push(deleteDoc(docSnap.ref));
      });
      await Promise.all(promises);
      weeksData = [];
      renderWeeksTable();
      renderCharts();
      updateMotivation();
      weekMessage.textContent = "Todas as semanas foram apagadas.";
      setTimeout(() => { weekMessage.textContent = ""; }, 3000);
    });

    // --- MOTIVA√á√ÉO ---
    function updateMotivation() {
      if (!weeksData.length) {
        motivationEmoji.textContent = "‚ú®";
        motivationText.textContent = "Come√ßo de tudo: preencha a semana 1 e marque esse ponto zero. O resto √© curva descendente.";
        return;
      }

      const sorted = [...weeksData].sort((a, b) => (a.week || 0) - (b.week || 0));
      const last = sorted[sorted.length - 1];
      const prev = sorted.length > 1 ? sorted[sorted.length - 2] : null;

      const gw = goalWeight.value ? parseFloat(goalWeight.value.replace(",", ".")) : null;
      const sw = startWeight.value ? parseFloat(startWeight.value.replace(",", ".")) : null;

      if (gw && last.weight && last.weight <= gw) {
        motivationEmoji.textContent = "üéâ";
        motivationText.textContent = "Meta alcan√ßada! Agora o desafio √© manter. N√£o some, porque manter √© mais dif√≠cil que chegar. üòâ";
        return;
      }

      if (prev && last.weight && prev.weight) {
        if (last.weight < prev.weight) {
          motivationEmoji.textContent = "üî•";
          motivationText.textContent = `Desceu de ${prev.weight.toFixed(1)} kg para ${last.weight.toFixed(1)} kg. Quem diria que disciplina emagrece mais que filtro do Instagram, n√©?`;
          return;
        }
        if (last.weight > prev.weight) {
          motivationEmoji.textContent = "üçï";
          motivationText.textContent = `Peso subiu um pouco (${prev.weight.toFixed(1)} ‚Üí ${last.weight.toFixed(1)} kg). Acontece. S√≥ n√£o deixa ‚Äús√≥ hoje‚Äù virar ‚Äúano que vem eu come√ßo‚Äù.`;
          return;
        }
      }

      if (sw && last.weight && last.weight < sw) {
        motivationEmoji.textContent = "üöÄ";
        motivationText.textContent = `Voc√™ j√° saiu de ${sw.toFixed(1)} kg para ${last.weight.toFixed(1)} kg. O ‚Äúeu do futuro‚Äù est√° oficialmente te aplaudindo de p√©.`;
        return;
      }

      motivationEmoji.textContent = "üí™";
      motivationText.textContent = "Os dados est√£o entrando. Agora √© seguir colocando semana a semana. O app faz os gr√°ficos, voc√™ faz a m√°gica.";
    }

    // --- RECOMENDA√á√ïES DE TREINO / DIETA ---
    function updateRecommendations() {
      // treino
      const gType = goalType.value;
      const gender = profileGender.value;
      let htmlTreino = "";
      if (!gType) {
        htmlTreino = "Selecione um objetivo no perfil para ver a divis√£o sugerida de treinos.";
      } else if (gType === "emagrecimento") {
        htmlTreino = `
          <ul>
            <li><strong>Frequ√™ncia ideal:</strong> 3‚Äì5x por semana.</li>
            <li><strong>Muscula√ß√£o:</strong> 3x/semana em esquema full body (corpo todo) com foco em movimentos b√°sicos.</li>
            <li><strong>Cardio:</strong> 20‚Äì40 min ap√≥s treino ou em dias alternados (caminhada acelerada, bike, el√≠ptico).</li>
          </ul>
        `;
      } else if (gType === "hipertrofia") {
        htmlTreino = `
          <ul>
            <li><strong>Frequ√™ncia ideal:</strong> 4‚Äì6x por semana.</li>
            <li><strong>Divis√£o sugerida:</strong> 
              ${gender === "F"
                ? "Inferiores (perna/gl√∫teo) 2x + Superiores 2x + 1 dia opcional de foco extra em gl√∫teo."
                : "Peito/Tr√≠ceps ‚Ä¢ Costas/B√≠ceps ‚Ä¢ Pernas ‚Ä¢ Ombro/Abd√¥men (pode repetir pernas ou superiores)."}
            </li>
            <li><strong>Estilo:</strong> 3‚Äì4 s√©ries de 8‚Äì12 repeti√ß√µes, buscando progress√£o de carga.</li>
          </ul>
        `;
      } else if (gType === "recomposicao") {
        htmlTreino = `
          <ul>
            <li><strong>Frequ√™ncia ideal:</strong> 4‚Äì5x por semana.</li>
            <li>Muscula√ß√£o forte + 2‚Äì3 sess√µes de cardio leve/moderado.</li>
            <li>Controle fino de dieta (n√£o comer de menos nem demais).</li>
          </ul>
        `;
      } else {
        htmlTreino = `
          <ul>
            <li><strong>Frequ√™ncia ideal:</strong> 3‚Äì4x por semana, alternando muscula√ß√£o e cardio.</li>
          </ul>
        `;
      }
      workoutSuggestions.innerHTML = htmlTreino;

      // dieta
      const dType = dietType.value;
      let htmlDieta = "";
      if (!dType) {
        htmlDieta = "Selecione um tipo de dieta no perfil para ver a tabelinha de alimentos recomendados x evitar.";
      } else if (dType === "lowcarb") {
        htmlDieta = `
          <table>
            <thead>
              <tr><th>Recomendados</th><th>Evitar / reduzir</th></tr>
            </thead>
            <tbody>
              <tr><td>Carnes magras, ovos, peixes</td><td>P√£es, massas, bolos, biscoitos</td></tr>
              <tr><td>Verduras, legumes, saladas</td><td>Refrigerantes, sucos a√ßucarados</td></tr>
              <tr><td>Oleaginosas (castanhas, nozes)</td><td>Doces em geral</td></tr>
              <tr><td>Queijos, iogurte natural</td><td>Arroz e batata em excesso</td></tr>
            </tbody>
          </table>
        `;
      } else if (dType === "highprotein") {
        htmlDieta = `
          <table>
            <thead>
              <tr><th>Recomendados</th><th>Evitar / reduzir</th></tr>
            </thead>
            <tbody>
              <tr><td>Frango, peixe, carne magra</td><td>Frituras frequentes</td></tr>
              <tr><td>Ovos, whey, iogurte grego</td><td>Fast food</td></tr>
              <tr><td>Arroz integral, feij√£o, legumes</td><td>Excesso de √°lcool</td></tr>
              <tr><td>Frutas em por√ß√µes controladas</td><td>Doces todo dia</td></tr>
            </tbody>
          </table>
        `;
      } else if (dType === "hipercalorica") {
        htmlDieta = `
          <table>
            <thead>
              <tr><th>Recomendados</th><th>Evitar / reduzir</th></tr>
            </thead>
            <tbody>
              <tr><td>Arroz, batata, aveia, massas</td><td>Calorias vazias (s√≥ a√ß√∫car)</td></tr>
              <tr><td>Prote√≠nas em todas as refei√ß√µes</td><td>Pular refei√ß√µes importantes</td></tr>
              <tr><td>Oleaginosas, azeite, abacate</td><td>‚ÄúBulking de lixo‚Äù o tempo todo</td></tr>
            </tbody>
          </table>
        `;
      } else if (dType === "mediterranea") {
        htmlDieta = `
          <table>
            <thead>
              <tr><th>Recomendados</th><th>Evitar / reduzir</th></tr>
            </thead>
            <tbody>
              <tr><td>Peixes, azeite de oliva, castanhas</td><td>Ultraprocessados</td></tr>
              <tr><td>Frutas, legumes, gr√£os integrais</td><td>Refrigerantes e embutidos</td></tr>
              <tr><td>Latic√≠nios em modera√ß√£o</td><td>Doces frequentes</td></tr>
            </tbody>
          </table>
        `;
      }
      dietSuggestions.innerHTML = htmlDieta;
    }

    // Atualiza BMI/resumo quando campos mudam
    [heightCm, startWeight, goalWeight].forEach(el => {
      el.addEventListener("input", () => {
        updateBmiSummary();
        renderWeeksTable();
        renderCharts();
      });
    });
    [goalType, dietType, profileGender].forEach(el => {
      el.addEventListener("change", () => {
        updateRecommendations();
        updateMotivation();
      });
    });

  </script>
</body>
</html>
