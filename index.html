<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Sua evolu√ß√£o come√ßa aqui</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #05050a;
      --card: #101322;
      --accent: #4cc9f0;
      --accent2: #f72585;
      --text: #f5f5f5;
      --muted: #8a8fa3;
      --border: #222533;
      --danger: #ff6b6b;
      --ok: #51cf66;
    }

    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      background: radial-gradient(circle at top, #15192f, #02030a);
      color: var(--text);
      min-height: 100vh;
    }

    .shell {
      max-width: 1120px;
      margin: 0 auto;
      padding: 20px 12px 40px;
    }

    .card {
      background: linear-gradient(145deg, #111521, #090b12);
      border-radius: 18px;
      padding: 18px 16px;
      border: 1px solid var(--border);
      box-shadow: 0 18px 55px rgba(0,0,0,0.6);
      margin-bottom: 18px;
    }

    h1, h2, h3 {
      margin: 0 0 8px;
    }

    h1 {
      font-size: 1.9rem;
      letter-spacing: 0.06em;
      text-transform: uppercase;
    }

    h2 {
      font-size: 1.1rem;
    }

    .badge-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 6px;
    }

    .badge {
      font-size: 0.75rem;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      color: var(--muted);
    }

    .badge-accent {
      border-color: var(--accent);
      color: var(--accent);
    }

    .badge-premium {
      border-color: var(--accent2);
      color: var(--accent2);
    }

    .meta-row {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      margin-top: 10px;
      font-size: 0.85rem;
      color: var(--muted);
    }

    .meta-label {
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-size: 0.7rem;
      color: #6b7086;
    }

    .grid {
      display: grid;
      grid-template-columns: minmax(0, 1.3fr) minmax(0, 1.1fr);
      gap: 16px;
    }
    @media (max-width: 880px) {
      .grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    label {
      display: block;
      font-size: 0.8rem;
      margin-bottom: 4px;
      color: var(--muted);
    }

    input, select, textarea {
      width: 100%;
      padding: 10px 11px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #070910;
      color: var(--text);
      font-size: 0.9rem;
      outline: none;
      resize: vertical;
    }

    input:focus, select:focus, textarea:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(76,201,240,0.3);
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap: 10px;
    }
    @media (max-width: 720px) {
      .form-grid {
        grid-template-columns: repeat(2, minmax(0,1fr));
      }
    }
    @media (max-width: 480px) {
      .form-grid {
        grid-template-columns: minmax(0,1fr);
      }
    }

    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 12px;
    }
    button {
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 0.85rem;
      padding: 11px 18px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      font-weight: 500;
      letter-spacing: 0.04em;
      text-transform: uppercase;
    }
    .btn-primary {
      background: linear-gradient(135deg, var(--accent), #4895ef);
      color: #020308;
      box-shadow: 0 12px 30px rgba(72,149,239,0.45);
      flex: 1;
    }
    .btn-ghost {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--muted);
      min-width: 160px;
    }
    .btn-danger {
      background: transparent;
      border: 1px solid var(--danger);
      color: var(--danger);
      min-width: 160px;
    }
    @media (max-width: 600px) {
      .btn-row {
        flex-direction: column;
      }
      .btn-primary, .btn-ghost, .btn-danger {
        width: 100%;
      }
    }

    .table-wrap {
      overflow-x: auto;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: #05060b;
      -webkit-overflow-scrolling: touch;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
      min-width: 620px;
    }
    thead {
      background: linear-gradient(90deg, #101320, #15192a);
    }
    th, td {
      padding: 8px 10px;
      text-align: left;
      white-space: nowrap;
    }
    th {
      font-weight: 600;
      font-size: 0.75rem;
      color: #c4c7de;
      border-bottom: 1px solid var(--border);
    }
    tbody tr:nth-child(even) {
      background: rgba(255,255,255,0.015);
    }
    tbody tr:hover {
      background: rgba(76,201,240,0.06);
    }

    .pill {
      padding: 2px 7px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.12);
      font-size: 0.7rem;
      color: var(--muted);
    }

    canvas {
      width: 100% !important;
      height: 260px !important;
    }

    .small {
      font-size: 0.75rem;
      color: var(--muted);
      margin-top: 6px;
    }

    .tagline {
      margin-top: 8px;
      font-size: 0.95rem;
      color: var(--muted);
    }

    .motivation {
      margin-top: 8px;
      font-size: 0.9rem;
      color: var(--ok);
    }

    /* Tela de login */
    #auth-screen {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .auth-card {
      max-width: 420px;
      width: 100%;
    }
    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }
    .tab {
      flex: 1;
      text-align: center;
      padding: 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      font-size: 0.8rem;
      cursor: pointer;
      color: var(--muted);
    }
    .tab.active {
      border-color: var(--accent);
      color: var(--accent);
      background: rgba(76,201,240,0.08);
    }

    .error-msg {
      margin-top: 6px;
      font-size: 0.75rem;
      color: var(--danger);
    }

    .success-msg {
      margin-top: 6px;
      font-size: 0.75rem;
      color: var(--ok);
    }

    @media (max-width: 480px) {
      h1 {
        font-size: 1.5rem;
      }
      .shell {
        padding: 16px 10px 32px;
      }
      .card {
        padding: 16px 12px;
        border-radius: 14px;
      }
    }
  </style>
</head>
<body>

  <!-- TELA DE AUTENTICA√á√ÉO -->
  <div id="auth-screen">
    <div class="card auth-card">
      <h2 style="margin-bottom:4px;">Sua evolu√ß√£o come√ßa aqui</h2>
      <p class="small">
        Crie sua conta ou fa√ßa login. Cada pessoa tem seus dados separados por login.
      </p>

      <div class="tabs">
        <div class="tab active" id="tab-login">Entrar</div>
        <div class="tab" id="tab-register">Criar conta</div>
      </div>

      <div id="auth-form-login">
        <label for="login-email">E-mail</label>
        <input id="login-email" type="email" placeholder="voce@exemplo.com" />
        <label for="login-password" style="margin-top:8px;">Senha</label>
        <input id="login-password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
        <button class="btn-primary" style="margin-top:12px;" id="login-btn">Entrar</button>
      </div>

      <div id="auth-form-register" style="display:none;">
        <label for="reg-name">Nome</label>
        <input id="reg-name" type="text" placeholder="Seu nome" />
        <label for="reg-email" style="margin-top:8px;">E-mail</label>
        <input id="reg-email" type="email" placeholder="voce@exemplo.com" />
        <label for="reg-password" style="margin-top:8px;">Senha</label>
        <input id="reg-password" type="password" placeholder="m√≠n. 6 caracteres" />
        <button class="btn-primary" style="margin-top:12px;" id="register-btn">Criar conta</button>
      </div>

      <div id="auth-message" class="error-msg"></div>
    </div>
  </div>

  <!-- APLICATIVO PRINCIPAL -->
  <div id="app-screen" style="display:none;">
    <div class="shell">

      <!-- HEADER -->
      <div class="card">
        <div style="display:flex;justify-content:space-between;gap:12px;align-items:flex-start;">
          <div>
            <h1>Sua evolu√ß√£o come√ßa aqui</h1>
            <p class="tagline">
              Painel Dark Premium para acompanhar peso, medidas, sensa√ß√£o di√°ria
              e rotina saud√°vel ‚Äî sem neura, s√≥ const√¢ncia.
            </p>
            <div class="badge-row">
              <span class="badge badge-accent">Objetivo: definido por voc√™</span>
              <span class="badge badge-premium">Dark Premium</span>
              <span class="badge">Dom√≠nio: esoares.net.br</span>
            </div>
          </div>
          <div style="text-align:right;font-size:0.8rem;color:var(--muted);">
            <div id="user-name-display" style="font-weight:600;"></div>
            <button id="logout-btn" class="btn-ghost" style="margin-top:6px;">Sair</button>
          </div>
        </div>
        <div class="meta-row">
          <div>
            <div class="meta-label">Conta</div>
            <div id="user-email-display"></div>
          </div>
          <div>
            <div class="meta-label">Modo</div>
            <div>1 login = 1 espa√ßo pessoal</div>
          </div>
          <div>
            <div class="meta-label">Aviso</div>
            <div>Este painel n√£o substitui m√©dico ou nutricionista üôè</div>
          </div>
        </div>
        <div id="motivation-banner" class="motivation"></div>
      </div>

      <!-- GRID: PERFIL / GR√ÅFICO -->
      <div class="grid">
        <!-- PERFIL / METAS -->
        <div class="card">
          <h2>Configura√ß√µes iniciais & metas</h2>
          <p class="small">
            Preencha seu peso inicial, meta e medidas. Esses dados ficam s√≥ na sua conta.
          </p>

          <div class="form-grid" style="margin-top:10px;">
            <div>
              <label for="initial-weight">Peso inicial (kg)</label>
              <input type="number" step="0.1" id="initial-weight" />
            </div>
            <div>
              <label for="goal-weight">Peso meta (kg)</label>
              <input type="number" step="0.1" id="goal-weight" />
            </div>
            <div>
              <label for="sex">Sexo</label>
              <select id="sex">
                <option value="">Selecione...</option>
                <option value="masculino">Masculino</option>
                <option value="feminino">Feminino</option>
                <option value="outro">Outro / Prefiro n√£o dizer</option>
              </select>
            </div>
            <div>
              <label for="initial-waist">Cintura inicial (cm)</label>
              <input type="number" step="0.1" id="initial-waist" />
            </div>
            <div>
              <label for="initial-hip">Quadril inicial (cm)</label>
              <input type="number" step="0.1" id="initial-hip" />
            </div>
            <div>
              <label for="main-goal">Objetivo principal</label>
              <select id="main-goal">
                <option value="">Selecione...</option>
                <option value="perda">Perder gordura</option>
                <option value="ganho">Ganhar massa magra</option>
                <option value="manutencao">Manuten√ß√£o saud√°vel</option>
              </select>
            </div>
          </div>

          <div class="btn-row">
            <button class="btn-primary" id="save-profile-btn">Salvar perfil</button>
          </div>
          <div id="profile-msg" class="success-msg"></div>
        </div>

        <!-- GR√ÅFICO -->
        <div class="card" style="min-height:300px;">
          <h2>Gr√°fico de progresso (peso & cintura)</h2>
          <p class="small">
            Linha azul = Peso (kg) ‚Ä¢ Linha rosa = Cintura (cm). 
            Tend√™ncia importa mais que perfei√ß√£o.
          </p>
          <div style="height:260px;margin-top:6px;">
            <canvas id="progressChart"></canvas>
          </div>
        </div>
      </div>

      <!-- REGISTRO SEMANAL -->
      <div class="card">
        <h2>Registrar semana</h2>
        <p class="small">
          Cada linha fica salva no seu banco de dados (Firestore). 
          Depois de salvar, o gr√°fico e a tabela atualizam.
        </p>

        <div style="margin-top:10px;">
          <label for="week">Semana</label>
          <select id="week">
            <option value="">Selecione...</option>
            <option value="1">Semana 1</option>
            <option value="2">Semana 2</option>
            <option value="3">Semana 3</option>
            <option value="4">Semana 4</option>
            <option value="5">Semana 5</option>
            <option value="6">Semana 6</option>
            <option value="7">Semana 7</option>
            <option value="8">Semana 8</option>
            <option value="9">Semana 9</option>
            <option value="10">Semana 10</option>
            <option value="11">Semana 11</option>
            <option value="12">Semana 12</option>
          </select>
        </div>

        <div class="form-grid" style="margin-top:10px;">
          <div>
            <label for="peso">Peso da semana (kg)</label>
            <input type="number" step="0.1" id="peso" placeholder="Ex: 87.0" />
          </div>
          <div>
            <label for="cintura">Cintura (cm)</label>
            <input type="number" step="0.1" id="cintura" placeholder="Ex: 90" />
          </div>
          <div>
            <label for="energia">Energia (1‚Äì10)</label>
            <input type="number" min="1" max="10" id="energia" placeholder="Ex: 8" />
          </div>
          <div>
            <label for="humor">Humor (1‚Äì10)</label>
            <input type="number" min="1" max="10" id="humor" placeholder="Ex: 9" />
          </div>
          <div>
            <label for="sono">Sono (1‚Äì10)</label>
            <input type="number" min="1" max="10" id="sono" placeholder="Ex: 7" />
          </div>
        </div>

        <div style="margin-top:10px;">
          <label for="obs">Observa√ß√µes</label>
          <input type="text" id="obs" placeholder="Ex: semana com mais cardio, menos fome, etc." />
        </div>

        <div class="btn-row">
          <button class="btn-primary" id="addWeekBtn">Ôºã Salvar semana</button>
          <button class="btn-danger" id="clearLocalBtn">Limpar cache local (opcional)</button>
        </div>

        <p class="small">
          Obs: os dados ficam no Firestore, mas tamb√©m fazemos um cache local r√°pido
          para carregar mais r√°pido neste dispositivo.
        </p>
      </div>

      <!-- TABELA -->
      <div class="card">
        <h2>Hist√≥rico completo</h2>
        <p class="small">
          Di√°rio de progresso. Role para o lado se estiver no celular.
        </p>
        <div class="table-wrap">
          <table id="historyTable">
            <thead>
              <tr>
                <th>Semana</th>
                <th>Peso (kg)</th>
                <th>Cintura (cm)</th>
                <th>Energia</th>
                <th>Humor</th>
                <th>Sono</th>
                <th>Observa√ß√µes</th>
              </tr>
            </thead>
            <tbody>
              <!-- preenchido via JS -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- NUTRI√á√ÉO & SUPLEMENTOS -->
      <div class="card">
        <h2>Nutri√ß√£o & Suplementos (por usu√°rio)</h2>
        <p class="small">
          Espa√ßo para registrar o que voc√™ est√° usando e receber sugest√µes gerais.
          N√£o substitui orienta√ß√£o profissional.
        </p>

        <div class="form-grid" style="margin-top:10px;">
          <div>
            <label for="diet-type">Estilo de dieta</label>
            <select id="diet-type">
              <option value="">Selecione...</option>
              <option value="lowcarb">Low carb</option>
              <option value="equilibrada">Equilibrada</option>
              <option value="hiperproteica">Hiperproteica</option>
            </select>
          </div>
          <div>
            <label for="goal-nutrition">Objetivo da dieta</label>
            <select id="goal-nutrition">
              <option value="">Selecione...</option>
              <option value="perda">Perder gordura</option>
              <option value="ganho">Ganhar massa</option>
              <option value="energia">Mais energia / disposi√ß√£o</option>
            </select>
          </div>
        </div>

        <div style="margin-top:10px;">
          <label for="user-supplements">O que voc√™ est√° usando? (vitaminas, suplementos, etc.)</label>
          <textarea id="user-supplements" rows="3"
            placeholder="Ex: multivitam√≠nico di√°rio, whey, creatina..."></textarea>
        </div>

        <div class="btn-row">
          <button class="btn-primary" id="save-nutrition-btn">Salvar anota√ß√µes</button>
          <button class="btn-ghost" id="ai-suggest-btn">Sugest√µes gerais da IA</button>
        </div>

        <div id="nutrition-msg" class="success-msg"></div>

        <div id="ai-suggestions" class="small" style="margin-top:10px;"></div>

        <p class="small" style="margin-top:8px;">
          Lembrete amigo: qualquer ajuste de vitamina, suplemento ou rem√©dio
          deve ser combinado com seu m√©dico ou nutricionista. Aqui √© s√≥ organiza√ß√£o
          + dicas gen√©ricas, nada de prescri√ß√£o üòâ
        </p>
      </div>

    </div>
  </div>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Firebase + App (modular, via CDN) -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js';
    import {
      getAuth,
      onAuthStateChanged,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      signOut,
      updateProfile
    } from 'https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js';
    import {
      getFirestore,
      doc,
      setDoc,
      getDoc,
      collection,
      getDocs,
      query,
      orderBy
    } from 'https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js';

    // === CONFIGURA√á√ÉO DO FIREBASE (a que voc√™ copiou do console) ===
    const firebaseConfig = {
      apiKey: "AIzaSyBbz-DjxSv2S2g1qkWca8YpNn3g7C4Oic0",
      authDomain: "evolucao-dark-premium.firebaseapp.com",
      projectId: "evolucao-dark-premium",
      storageBucket: "evolucao-dark-premium.firebasestorage.app",
      messagingSenderId: "1041789751060",
      appId: "1:1041789751060:web:eb2afd0d1a4af526e0fc01"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // === ELEMENTOS B√ÅSICOS ===
    const authScreen   = document.getElementById('auth-screen');
    const appScreen    = document.getElementById('app-screen');
    const authMsg      = document.getElementById('auth-message');
    const profileMsg   = document.getElementById('profile-msg');
    const nutritionMsg = document.getElementById('nutrition-msg');
    const motivationBanner = document.getElementById('motivation-banner');

    // Abas login/cadastro
    const tabLogin    = document.getElementById('tab-login');
    const tabRegister = document.getElementById('tab-register');
    const formLogin   = document.getElementById('auth-form-login');
    const formReg     = document.getElementById('auth-form-register');

    tabLogin.addEventListener('click', () => {
      tabLogin.classList.add('active');
      tabRegister.classList.remove('active');
      formLogin.style.display = '';
      formReg.style.display = 'none';
      authMsg.textContent = '';
    });

    tabRegister.addEventListener('click', () => {
      tabRegister.classList.add('active');
      tabLogin.classList.remove('active');
      formLogin.style.display = 'none';
      formReg.style.display = '';
      authMsg.textContent = '';
    });

    // === AUTENTICA√á√ÉO ===
    document.getElementById('register-btn').addEventListener('click', async () => {
      authMsg.textContent = '';
      const name = document.getElementById('reg-name').value.trim();
      const email = document.getElementById('reg-email').value.trim();
      const pass = document.getElementById('reg-password').value;

      if (!name || !email || !pass) {
        authMsg.textContent = 'Preencha nome, e-mail e senha.';
        return;
      }

      try {
        const cred = await createUserWithEmailAndPassword(auth, email, pass);
        await updateProfile(cred.user, { displayName: name });
        authMsg.textContent = '';
      } catch (err) {
        console.error(err);
        authMsg.textContent = 'Erro ao criar conta: ' + (err.message || '');
      }
    });

    document.getElementById('login-btn').addEventListener('click', async () => {
      authMsg.textContent = '';
      const email = document.getElementById('login-email').value.trim();
      const pass = document.getElementById('login-password').value;

      if (!email || !pass) {
        authMsg.textContent = 'Informe e-mail e senha.';
        return;
      }

      try {
        await signInWithEmailAndPassword(auth, email, pass);
        authMsg.textContent = '';
      } catch (err) {
        console.error(err);
        authMsg.textContent = 'Erro ao entrar: ' + (err.message || '');
      }
    });

    document.getElementById('logout-btn').addEventListener('click', () => {
      signOut(auth);
    });

    // === VARI√ÅVEIS DE DADOS ===
    let currentUser = null;
    let profileData = {};
    let weeksData   = []; // array de { weekNumber, peso, cintura, ... }

    const STORAGE_KEY_CACHE = 'evolucao_dark_cache';

    function cacheLocal(uid, profile, weeks, nutrition) {
      const payload = { uid, profile, weeks, nutrition };
      localStorage.setItem(STORAGE_KEY_CACHE, JSON.stringify(payload));
    }

    function readLocalCache(uid) {
      const raw = localStorage.getItem(STORAGE_KEY_CACHE);
      if (!raw) return null;
      try {
        const obj = JSON.parse(raw);
        if (obj.uid === uid) return obj;
      } catch {}
      return null;
    }

    document.getElementById('clearLocalBtn').addEventListener('click', () => {
      if (confirm('Limpar o cache local deste dispositivo?')) {
        localStorage.removeItem(STORAGE_KEY_CACHE);
        alert('Cache local apagado. Dados no Firebase continuam salvos.');
      }
    });

    // === FIRESTORE ‚Äì PERFIL ===
    async function loadProfile(uid) {
      const ref = doc(db, 'users', uid);
      const snap = await getDoc(ref);
      if (snap.exists()) {
        profileData = snap.data();
      } else {
        profileData = {};
      }
      fillProfileForm();
    }

    async function saveProfile(uid) {
      profileMsg.textContent = '';

      const initialWeight = parseFloat(document.getElementById('initial-weight').value || '0');
      const goalWeight    = parseFloat(document.getElementById('goal-weight').value || '0');
      const sex           = document.getElementById('sex').value || null;
      const initialWaist  = parseFloat(document.getElementById('initial-waist').value || '0');
      const initialHip    = parseFloat(document.getElementById('initial-hip').value || '0');
      const mainGoal      = document.getElementById('main-goal').value || null;

      const ref = doc(db, 'users', uid);
      const data = {
        initialWeight: isNaN(initialWeight) ? null : initialWeight,
        goalWeight:    isNaN(goalWeight) ? null : goalWeight,
        sex,
        initialWaist:  isNaN(initialWaist) ? null : initialWaist,
        initialHip:    isNaN(initialHip) ? null : initialHip,
        mainGoal,
        updatedAt: new Date()
      };

      await setDoc(ref, data, { merge: true });
      profileData = { ...(profileData || {}), ...data };

      await loadWeeks(uid); // para recalcular motiva√ß√£o
      updateMotivation();
      profileMsg.textContent = 'Perfil salvo com sucesso ‚úÖ';

      const nutritionObj = await loadNutrition(uid); // para cache completo
      cacheLocal(uid, profileData, weeksData, nutritionObj);
    }

    function fillProfileForm() {
      document.getElementById('initial-weight').value = profileData.initialWeight ?? '';
      document.getElementById('goal-weight').value    = profileData.goalWeight ?? '';
      document.getElementById('sex').value            = profileData.sex ?? '';
      document.getElementById('initial-waist').value  = profileData.initialWaist ?? '';
      document.getElementById('initial-hip').value    = profileData.initialHip ?? '';
      document.getElementById('main-goal').value      = profileData.mainGoal ?? '';
      updateMotivation();
    }

    document.getElementById('save-profile-btn').addEventListener('click', () => {
      if (!currentUser) return;
      saveProfile(currentUser.uid).catch(err => {
        console.error(err);
        profileMsg.textContent = 'Erro ao salvar perfil.';
      });
    });

    // === FIRESTORE ‚Äì SEMANAS ===
    async function loadWeeks(uid) {
      const colRef = collection(db, 'users', uid, 'weeks');
      const q = query(colRef, orderBy('weekNumber', 'asc'));
      const snap = await getDocs(q);
      weeksData = [];
      snap.forEach(docSnap => {
        weeksData.push(docSnap.data());
      });
      renderTable();
      renderChart();
      updateMotivation();
    }

    async function saveWeek(uid) {
      const week = parseInt(document.getElementById('week').value, 10);
      const peso = parseFloat((document.getElementById('peso').value || '').replace(',', '.'));
      const cintura = parseFloat((document.getElementById('cintura').value || '').replace(',', '.'));
      const energia = document.getElementById('energia').value ? parseInt(document.getElementById('energia').value, 10) : null;
      const humor   = document.getElementById('humor').value ? parseInt(document.getElementById('humor').value, 10) : null;
      const sono    = document.getElementById('sono').value ? parseInt(document.getElementById('sono').value, 10) : null;
      const obs     = document.getElementById('obs').value.trim();

      if (!week || isNaN(week)) {
        alert('Selecione a semana.');
        return;
      }
      if (isNaN(peso)) {
        alert('Informe o peso (kg).');
        return;
      }

      const data = {
        weekNumber: week,
        peso,
        cintura: isNaN(cintura) ? null : cintura,
        energia,
        humor,
        sono,
        obs,
        updatedAt: new Date()
      };

      const ref = doc(db, 'users', uid, 'weeks', String(week));
      await setDoc(ref, data, { merge: true });

      await loadWeeks(uid);

      const nutritionObj = await loadNutrition(uid);
      cacheLocal(uid, profileData, weeksData, nutritionObj);
    }

    document.getElementById('addWeekBtn').addEventListener('click', () => {
      if (!currentUser) return;
      saveWeek(currentUser.uid).catch(err => {
        console.error(err);
        alert('Erro ao salvar semana (veja o console).');
      });
    });

    const tableBody = document.querySelector('#historyTable tbody');
    let chartInstance = null;

    function renderTable() {
      tableBody.innerHTML = '';
      const sorted = [...weeksData].sort((a, b) => (a.weekNumber || 0) - (b.weekNumber || 0));
      for (const row of sorted) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><span class="pill">Semana ${row.weekNumber}</span></td>
          <td>${row.peso ?? ''}</td>
          <td>${row.cintura ?? ''}</td>
          <td>${row.energia ?? ''}</td>
          <td>${row.humor ?? ''}</td>
          <td>${row.sono ?? ''}</td>
          <td>${row.obs ?? ''}</td>
        `;
        tableBody.appendChild(tr);
      }
    }

    function renderChart() {
      const ctx = document.getElementById('progressChart').getContext('2d');
      const sorted = [...weeksData].sort((a, b) => (a.weekNumber || 0) - (b.weekNumber || 0));
      const labels = sorted.map(d => 'S' + d.weekNumber);
      const pesos  = sorted.map(d => d.peso ?? null);
      const cint   = sorted.map(d => d.cintura ?? null);

      if (chartInstance) chartInstance.destroy();

      chartInstance = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [
            {
              label: 'Peso (kg)',
              data: pesos,
              borderColor: '#4cc9f0',
              backgroundColor: 'rgba(76,201,240,0.1)',
              borderWidth: 2,
              tension: 0.35,
              pointRadius: 3
            },
            {
              label: 'Cintura (cm)',
              data: cint,
              borderColor: '#f72585',
              backgroundColor: 'rgba(247,37,133,0.1)',
              borderWidth: 2,
              tension: 0.35,
              pointRadius: 3
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              labels: { color: '#d0d3ea', usePointStyle: true }
            }
          },
          scales: {
            x: {
              ticks: { color: '#9ba0c2' },
              grid: { color: 'rgba(255,255,255,0.03)' }
            },
            y: {
              ticks: { color: '#9ba0c2' },
              grid: { color: 'rgba(255,255,255,0.03)' }
            }
          }
        }
      });
    }

    // === NUTRI√á√ÉO & SUPLEMENTOS ===
    async function loadNutrition(uid) {
      const ref = doc(db, 'users', uid, 'meta', 'nutrition');
      const snap = await getDoc(ref);
      if (snap.exists()) {
        const data = snap.data();
        document.getElementById('diet-type').value = data.dietType ?? '';
        document.getElementById('goal-nutrition').value = data.goalNutrition ?? '';
        document.getElementById('user-supplements').value = data.userSupplements ?? '';
        return data;
      } else {
        document.getElementById('diet-type').value = '';
        document.getElementById('goal-nutrition').value = '';
        document.getElementById('user-supplements').value = '';
        return {};
      }
    }

    async function saveNutrition(uid) {
      nutritionMsg.textContent = '';
      const dietType  = document.getElementById('diet-type').value || null;
      const goalNut   = document.getElementById('goal-nutrition').value || null;
      const userSupps = document.getElementById('user-supplements').value.trim();

      const ref = doc(db, 'users', uid, 'meta', 'nutrition');
      const data = {
        dietType,
        goalNutrition: goalNut,
        userSupplements: userSupps,
        updatedAt: new Date()
      };

      await setDoc(ref, data, { merge: true });
      nutritionMsg.textContent = 'Anota√ß√µes salvas ‚úÖ';

      cacheLocal(uid, profileData, weeksData, data);
    }

    document.getElementById('save-nutrition-btn').addEventListener('click', () => {
      if (!currentUser) return;
      saveNutrition(currentUser.uid).catch(err => {
        console.error(err);
        nutritionMsg.textContent = 'Erro ao salvar nutri√ß√£o.';
      });
    });

    // ‚ÄúIA‚Äù local para sugest√µes gen√©ricas
    document.getElementById('ai-suggest-btn').addEventListener('click', () => {
      const dietType = document.getElementById('diet-type').value;
      const goal = document.getElementById('goal-nutrition').value;
      const sex = profileData.sex || null;

      const box = document.getElementById('ai-suggestions');

      let msgs = [];

      if (dietType === 'lowcarb') {
        msgs.push('‚Ä¢ Em low carb, priorize boas fontes de prote√≠na (ovos, carnes magras, latic√≠nios) e vegetais variados.');
        msgs.push('‚Ä¢ Combine low carb com ingest√£o adequada de √°gua e aten√ß√£o a fibras para o intestino n√£o travar.');
      } else if (dietType === 'hiperproteica') {
        msgs.push('‚Ä¢ Em dieta hiperproteica, distribua prote√≠na ao longo do dia (todas as refei√ß√µes).');
      } else if (dietType === 'equilibrada') {
        msgs.push('‚Ä¢ Dieta equilibrada: prato colorido, metade vegetais, 1/4 prote√≠na, 1/4 carbo de boa qualidade.');
      }

      if (goal === 'perda') {
        msgs.push('‚Ä¢ Para perda de gordura, o mais importante √© const√¢ncia no d√©ficit cal√≥rico leve + sono decente.');
      } else if (goal === 'ganho') {
        msgs.push('‚Ä¢ Para ganho de massa, combine treino de for√ßa progressivo com leve super√°vit cal√≥rico e prote√≠na suficiente.');
      } else if (goal === 'energia') {
        msgs.push('‚Ä¢ Energia ao longo do dia depende muito de sono, hidrata√ß√£o e regularidade das refei√ß√µes.');
      }

      if (sex === 'feminino') {
        msgs.push('‚Ä¢ Para mulheres, aten√ß√£o especial a ferro, c√°lcio e vitamina D ‚Äî sempre alinhado com exames e profissional.');
      } else if (sex === 'masculino') {
        msgs.push('‚Ä¢ Para homens, cuidado com ‚Äúcombo de suplementos‚Äù sem necessidade ‚Äî menos √© mais, foque no b√°sico bem feito.');
      }

      msgs.push('‚Ä¢ Vitamina / suplemento n√£o substitui comida de verdade nem acompanhamento m√©dico.');
      msgs.push('‚Ä¢ Melhor hor√°rio para suplementos costuma ser junto das refei√ß√µes, mas ajuste sempre com seu m√©dico/nutri.');

      box.textContent = msgs.join(' ');

    });

    // === MOTIVA√á√ÉO ENGRA√áADINHA ===
    function updateMotivation() {
      const last = [...weeksData].sort((a, b) => (a.weekNumber || 0) - (b.weekNumber || 0)).slice(-1)[0];
      const initial = profileData.initialWeight;
      const goal    = profileData.goalWeight;

      if (!last || !last.peso || !initial || !goal) {
        motivationBanner.textContent = 'Preencha peso inicial, meta e pelo menos uma semana para ver as mensagens motivacionais üòé';
        return;
      }

      const deltaFromInitial = last.peso - initial;
      const remainingToGoal = last.peso - goal;

      let msg = '';

      if (remainingToGoal <= 0) {
        msg = 'Meta batida! üéâ Agora √© modo ‚Äúmanuten√ß√£o de adulto respons√°vel‚Äù. Nada de comemorar com 3 pizzas, hein?';
      } else if (deltaFromInitial < -2) {
        msg = `Voc√™ j√° saiu de ${initial.toFixed(1)} kg para ${last.peso.toFixed(1)} kg. O projeto est√° andando! üöÄ`;
      } else if (deltaFromInitial > 2) {
        msg = 'Oscilou pra cima? Acontece. S√≥ n√£o desista: volte pro plano hoje, n√£o na segunda-feira infinita. üòâ';
      } else {
        msg = 'Peso est√° est√°vel. A const√¢ncia √© silenciosa, mas √© ela que muda tudo. Continue!';
      }

      motivationBanner.textContent = msg;
    }

    // === ON AUTH STATE CHANGED ===
    onAuthStateChanged(auth, async (user) => {
      currentUser = user;

      if (!user) {
        authScreen.style.display = 'flex';
        appScreen.style.display  = 'none';
        return;
      }

      document.getElementById('user-name-display').textContent  = user.displayName || 'Sem nome cadastrado';
      document.getElementById('user-email-display').textContent = user.email || '';

      authScreen.style.display = 'none';
      appScreen.style.display  = 'block';

      // Tenta carregar cache local primeiro (pra deixar r√°pido)
      const cached = readLocalCache(user.uid);
      if (cached) {
        profileData = cached.profile || {};
        weeksData   = cached.weeks   || [];
        fillProfileForm();
        renderTable();
        renderChart();
        updateMotivation();
        document.getElementById('diet-type').value = cached.nutrition?.dietType ?? '';
        document.getElementById('goal-nutrition').value = cached.nutrition?.goalNutrition ?? '';
        document.getElementById('user-supplements').value = cached.nutrition?.userSupplements ?? '';
      }

      // Depois sincroniza com Firestore ‚Äúpor cima‚Äù
      try {
        await loadProfile(user.uid);
        await loadWeeks(user.uid);
        const nutritionObj = await loadNutrition(user.uid);
        cacheLocal(user.uid, profileData, weeksData, nutritionObj);
      } catch (err) {
        console.error('Erro ao carregar dados do Firestore', err);
      }
    });

  </script>
</body>
</html>
