<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Sua evolu√ß√£o come√ßa aqui - Dark Premium</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0b0c10;
      --card: #12151f;
      --accent: #4cc9f0;
      --accent2: #f72585;
      --text: #f5f5f5;
      --muted: #8a8fa3;
      --border: #222533;
      --danger: #ff6b6b;
      --success: #51cf66;
    }

    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      background: radial-gradient(circle at top, #141b2d, #05060a);
      color: var(--text);
      min-height: 100vh;
    }

    .shell {
      max-width: 1120px;
      margin: 0 auto;
      padding: 20px 12px 40px;
    }

    .card {
      background: linear-gradient(145deg, #111521, #090b12);
      border-radius: 18px;
      padding: 18px 16px;
      border: 1px solid var(--border);
      box-shadow: 0 18px 55px rgba(0,0,0,0.6);
      margin-bottom: 18px;
    }

    h1, h2, h3 {
      margin: 0 0 8px;
    }

    h1 {
      font-size: 1.9rem;
      letter-spacing: 0.06em;
      text-transform: uppercase;
    }

    h2 {
      font-size: 1.1rem;
    }

    .badge-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 6px;
    }

    .badge {
      font-size: 0.75rem;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      color: var(--muted);
    }

    .badge-accent {
      border-color: var(--accent);
      color: var(--accent);
    }

    .badge-ghost {
      border-style: dashed;
    }

    .meta-row {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      margin-top: 10px;
      font-size: 0.85rem;
      color: var(--muted);
    }

    .meta-label {
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-size: 0.7rem;
      color: #6b7086;
    }

    .tagline {
      margin-top: 8px;
      font-size: 0.95rem;
      color: var(--muted);
      max-width: 620px;
    }

    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 10px;
    }

    .topbar-right {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 0.8rem;
      color: var(--muted);
    }

    .pill-small {
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 4px 10px;
      font-size: 0.75rem;
    }

    .btn-small {
      border-radius: 999px;
      border: none;
      cursor: pointer;
      padding: 7px 12px;
      font-size: 0.75rem;
      background: transparent;
      border: 1px solid var(--border);
      color: var(--muted);
    }

    .btn-small:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    /* Grids */
    .grid {
      display: grid;
      grid-template-columns: minmax(0, 1.3fr) minmax(0, 1.1fr);
      gap: 16px;
    }

    @media (max-width: 880px) {
      .grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .grid-2 {
      display: grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 12px;
    }

    @media (max-width: 720px) {
      .grid-2 {
        grid-template-columns: minmax(0,1fr);
      }
    }

    /* Form */
    label {
      display: block;
      font-size: 0.8rem;
      margin-bottom: 4px;
      color: var(--muted);
    }

    input, select {
      width: 100%;
      padding: 10px 11px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #070910;
      color: var(--text);
      font-size: 0.9rem;
      outline: none;
    }

    input:focus, select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(76,201,240,0.3);
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap: 10px;
    }

    @media (max-width: 720px) {
      .form-grid {
        grid-template-columns: repeat(2, minmax(0,1fr));
      }
    }

    @media (max-width: 480px) {
      .form-grid {
        grid-template-columns: minmax(0,1fr);
      }
    }

    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 12px;
    }

    button {
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 0.85rem;
      padding: 11px 18px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      font-weight: 500;
      letter-spacing: 0.04em;
      text-transform: uppercase;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent), #4895ef);
      color: #020308;
      box-shadow: 0 12px 30px rgba(72,149,239,0.45);
      flex: 1;
    }

    .btn-ghost {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--muted);
      min-width: 140px;
    }

    .btn-danger {
      background: transparent;
      border: 1px solid rgba(255,107,107,0.6);
      color: var(--danger);
    }

    @media (max-width: 600px) {
      .btn-row {
        flex-direction: column;
      }
      .btn-primary, .btn-ghost, .btn-danger {
        width: 100%;
      }
    }

    /* Table */
    .table-wrap {
      overflow-x: auto;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: #05060b;
      -webkit-overflow-scrolling: touch;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
      min-width: 620px;
    }

    thead {
      background: linear-gradient(90deg, #101320, #15192a);
    }

    th, td {
      padding: 8px 10px;
      text-align: left;
      white-space: nowrap;
    }

    th {
      font-weight: 600;
      font-size: 0.75rem;
      color: #c4c7de;
      border-bottom: 1px solid var(--border);
    }

    tbody tr:nth-child(even) {
      background: rgba(255,255,255,0.015);
    }

    tbody tr:hover {
      background: rgba(76,201,240,0.06);
    }

    .pill {
      padding: 2px 7px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.12);
      font-size: 0.7rem;
      color: var(--muted);
    }

    canvas {
      width: 100% !important;
      height: 260px !important;
    }

    .small {
      font-size: 0.75rem;
      color: var(--muted);
      margin-top: 6px;
    }

    .tagline-quote {
      font-style: italic;
      opacity: 0.9;
    }

    /* Motivacional */
    .motivation {
      border-radius: 16px;
      padding: 14px 14px;
      background: radial-gradient(circle at top left, rgba(76,201,240,0.18), transparent 55%),
                  radial-gradient(circle at bottom right, rgba(247,37,133,0.15), transparent 55%);
      border: 1px solid rgba(76,201,240,0.45);
      margin-top: 10px;
    }

    .motivation-title {
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--accent);
      margin-bottom: 4px;
    }

    .motivation-text {
      font-size: 0.9rem;
    }

    .motivation-highlight {
      color: var(--accent2);
      font-weight: 600;
    }

    /* Pills extras */
    .pill-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
    }

    .pill-tag {
      font-size: 0.7rem;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      color: var(--muted);
      background: rgba(255,255,255,0.01);
    }

    /* Links de v√≠deo */
    .video-link {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 0.8rem;
      text-decoration: none;
      color: var(--accent);
      border-radius: 999px;
      padding: 4px 8px;
      border: 1px solid rgba(76,201,240,0.35);
      margin: 2px 2px 2px 0;
    }

    .video-link span {
      font-size: 0.9rem;
    }

    .auth-note {
      font-size: 0.8rem;
      color: var(--muted);
      margin-top: 8px;
    }

    .toggle-auth {
      background: none;
      border: none;
      color: var(--accent);
      cursor: pointer;
      font-size: 0.8rem;
      padding: 0;
      text-decoration: underline;
    }

    .error-text {
      color: var(--danger);
      font-size: 0.78rem;
      margin-top: 6px;
    }

    @media (max-width: 480px) {
      h1 {
        font-size: 1.5rem;
      }
      .shell {
        padding: 16px 10px 32px;
      }
      .card {
        padding: 16px 12px;
        border-radius: 14px;
      }
    }
  </style>
</head>
<body>
  <div class="shell">

    <!-- HEADER / TOP -->
    <div class="card">
      <div class="topbar">
        <div>
          <h1>Sua evolu√ß√£o come√ßa aqui</h1>
          <p class="tagline">
            Painel Dark Premium para acompanhar peso, medidas, energia e humor.
            Cada usu√°rio com seu login, cada corpo no seu ritmo.
          </p>
          <div class="badge-row">
            <span class="badge badge-accent">Dark Premium</span>
            <span class="badge">Dom√≠nio: esoares.net.br</span>
            <span class="badge badge-ghost">Multiusu√°rio com Firebase</span>
          </div>
        </div>
        <div class="topbar-right" id="topbarUser" style="display:none;">
          <span class="pill-small" id="loggedEmail"></span>
          <button class="btn-small" id="logoutBtn">Sair</button>
        </div>
      </div>

      <div class="meta-row">
        <div>
          <div class="meta-label">Modo</div>
          <div>Dashboard de evolu√ß√£o corporal</div>
        </div>
        <div>
          <div class="meta-label">Dados</div>
          <div>Salvos em nuvem (Firebase)</div>
        </div>
        <div>
          <div class="meta-label">Acesso</div>
          <div>Login por e-mail e senha</div>
        </div>
      </div>
    </div>

    <!-- CARD: LOGIN / CADASTRO -->
    <div class="card" id="authCard">
      <h2 id="authTitle">Entrar na sua conta</h2>
      <p class="small">
        Crie uma conta ou fa√ßa login para salvar seu progresso e acessar de qualquer dispositivo.
      </p>

      <div class="grid-2">
        <div>
          <label for="authEmail">E-mail</label>
          <input type="email" id="authEmail" placeholder="voce@exemplo.com" />
        </div>
        <div>
          <label for="authPassword">Senha</label>
          <input type="password" id="authPassword" placeholder="M√≠nimo 6 caracteres" />
        </div>
      </div>

      <div class="btn-row">
        <button class="btn-primary" id="authMainBtn">Entrar</button>
        <button class="btn-ghost" id="authSecondaryBtn">Quero criar uma conta</button>
      </div>
      <div id="authError" class="error-text" style="display:none;"></div>

      <p class="auth-note">
        <span id="authModeText">
          Ainda n√£o tem conta?
          <button class="toggle-auth" id="toggleAuthMode">Criar conta</button>
        </span>
      </p>
    </div>

    <!-- CONTE√öDO PRINCIPAL (AP√ìS LOGIN) -->
    <div id="app" style="display:none;">

      <!-- CARD: DADOS INICIAIS / METAS + MENSAGEM -->
      <div class="card">
        <h2>Configurar dados iniciais e metas</h2>
        <p class="small">
          Preencha seu ponto de partida e aonde voc√™ quer chegar.
          O sistema usa isso para gerar mensagens motivacionais e acompanhar sua rota.
        </p>

        <div class="form-grid" style="margin-top:10px;">
          <div>
            <label for="startWeight">Peso inicial (kg)</label>
            <input type="number" step="0.1" id="startWeight" placeholder="Ex: 92.5" />
          </div>
          <div>
            <label for="startWaist">Cintura inicial (cm)</label>
            <input type="number" step="0.1" id="startWaist" placeholder="Ex: 100" />
          </div>
          <div>
            <label for="goalWeight">Peso meta (kg)</label>
            <input type="number" step="0.1" id="goalWeight" placeholder="Ex: 75.0" />
          </div>
          <div>
            <label for="goalWaist">Cintura meta (cm)</label>
            <input type="number" step="0.1" id="goalWaist" placeholder="Opcional" />
          </div>
          <div>
            <label for="goalDate">Prazo meta (data)</label>
            <input type="date" id="goalDate" />
          </div>
        </div>

        <div class="btn-row">
          <button class="btn-primary" id="saveMetaBtn">Salvar metas</button>
        </div>

        <div class="motivation" id="motivationBox">
          <div class="motivation-title">Modo turbo mental</div>
          <div class="motivation-text" id="motivationText">
            Preencha suas metas ali em cima e comece a registrar as semanas.
            A partir da√≠ eu viro seu narrador motivacional oficial. üòà
          </div>
        </div>
      </div>

      <!-- GRID: FORM + GR√ÅFICO -->
      <div class="grid">
        <!-- FORM SEMANAL -->
        <div class="card">
          <h2>Registrar semana</h2>
          <p class="small">
            Preencha os dados da semana e clique em <strong>Adicionar</strong>.
            O gr√°fico e a tabela s√£o atualizados automaticamente para o seu usu√°rio.
          </p>
          <div style="margin-top:10px;">
            <label for="week">Semana</label>
            <select id="week">
              <option value="">Selecione...</option>
              <option value="1">Semana 1</option>
              <option value="2">Semana 2</option>
              <option value="3">Semana 3</option>
              <option value="4">Semana 4</option>
              <option value="5">Semana 5</option>
              <option value="6">Semana 6</option>
              <option value="7">Semana 7</option>
              <option value="8">Semana 8</option>
              <option value="9">Semana 9</option>
              <option value="10">Semana 10</option>
              <option value="11">Semana 11</option>
              <option value="12">Semana 12</option>
            </select>
          </div>

          <div class="form-grid" style="margin-top:10px;">
            <div>
              <label for="peso">Peso (kg)</label>
              <input type="number" step="0.1" id="peso" placeholder="Ex: 87.0" />
            </div>
            <div>
              <label for="cintura">Cintura (cm)</label>
              <input type="number" step="0.1" id="cintura" placeholder="Ex: 90" />
            </div>
            <div>
              <label for="energia">Energia (1‚Äì10)</label>
              <input type="number" min="1" max="10" id="energia" placeholder="Ex: 8" />
            </div>
            <div>
              <label for="humor">Humor (1‚Äì10)</label>
              <input type="number" min="1" max="10" id="humor" placeholder="Ex: 9" />
            </div>
            <div>
              <label for="sono">Sono (1‚Äì10)</label>
              <input type="number" min="1" max="10" id="sono" placeholder="Ex: 7" />
            </div>
          </div>

          <div style="margin-top:10px;">
            <label for="obs">Observa√ß√µes</label>
            <input type="text" id="obs" placeholder="Ex: mais cardio, menos fome, viagem, etc." />
          </div>

          <div class="btn-row">
            <button class="btn-primary" id="addWeekBtn">Ôºã Adicionar semana</button>
            <button class="btn-danger" id="resetWeeksBtn">Apagar semanas (usu√°rio)</button>
          </div>

          <p class="small">
            Os dados s√£o salvos na nuvem para o seu usu√°rio. 
            Se trocar de celular ou computador, √© s√≥ logar com o mesmo e-mail.
          </p>
        </div>

        <!-- GR√ÅFICO -->
        <div class="card" style="min-height: 320px;">
          <h2>Gr√°fico de progresso</h2>
          <p class="small">
            Linha azul = Peso (kg) ‚Ä¢ Linha rosa = Cintura (cm). 
            O que importa √© a <strong>tend√™ncia</strong>, n√£o a neurose com a balan√ßa.
          </p>
          <div style="position:relative; height:260px; margin-top:8px;">
            <canvas id="progressChart"></canvas>
          </div>
          <p class="small tagline-quote">
            ‚ÄúSe a linha t√° descendo, o shape t√° vindo.‚Äù ‚Äì Algum fil√≥sofo da academia, provavelmente.
          </p>
        </div>
      </div>

      <!-- TABELA -->
      <div class="card">
        <h2>Hist√≥rico completo</h2>
        <p class="small">
          Di√°rio de progresso do seu corpo. Se estiver no celular, pode rolar pro lado.
        </p>
        <div class="table-wrap">
          <table id="historyTable">
            <thead>
              <tr>
                <th>Semana</th>
                <th>Peso (kg)</th>
                <th>Cintura (cm)</th>
                <th>Energia</th>
                <th>Humor</th>
                <th>Sono</th>
                <th>Observa√ß√µes</th>
              </tr>
            </thead>
            <tbody>
              <!-- preenchido via JS -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- TREINOS POR SEXO -->
      <div class="card">
        <h2>Treinos recomendados (masc / fem)</h2>
        <p class="small">
          Sugest√µes gerais para acompanhar o protocolo hormonal + dieta high protein. 
          Sempre respeite orienta√ß√µes do seu m√©dico/profissional.
        </p>

        <div class="grid-2" style="margin-top:8px;">
          <div>
            <h3>Foco Masculino</h3>
            <p class="small">
              Ideia geral: manter for√ßa, preservar massa magra e n√£o virar zumbi de cardio.
            </p>
            <ul class="small">
              <li><strong>4 treinos de muscula√ß√£o/semana</strong> 
                (peito+tr√≠ceps / costas+b√≠ceps / pernas / ombro+abd√¥men)</li>
              <li><strong>Cardio leve</strong> 20‚Äì30 min, 3x/semana (caminhada, bike, el√≠ptico)</li>
              <li>Priorizar b√°sicos: supino, remada, agachamento guiado, levantamento terra romeno leve</li>
            </ul>
            <p class="small">V√≠deos de execu√ß√£o sugeridos:</p>
            <a class="video-link" target="_blank" href="https://www.youtube.com/results?search_query=supino+reto+execu%C3%A7%C3%A3o+correta">
              <span>‚ñ∂</span><span>Supino reto ‚Äì execu√ß√£o</span>
            </a>
            <a class="video-link" target="_blank" href="https://www.youtube.com/results?search_query=agachamento+guiado+execu%C3%A7%C3%A3o+correta">
              <span>‚ñ∂</span><span>Agachamento guiado</span>
            </a>
            <a class="video-link" target="_blank" href="https://www.youtube.com/results?search_query=remada+curvada+execu%C3%A7%C3%A3o+correta">
              <span>‚ñ∂</span><span>Remada</span>
            </a>
          </div>
          <div>
            <h3>Foco Feminino</h3>
            <p class="small">
              Mais √™nfase em inferiores e gl√∫teos, sem esquecer membros superiores (ombro, costas).
            </p>
            <ul class="small">
              <li><strong>4‚Äì5 treinos de muscula√ß√£o/semana</strong> 
                (inferiores A / superiores / inferiores B / gl√∫teos+core / opcional full-body)</li>
              <li>Cardio leve 20‚Äì30 min, 3‚Äì5x/semana, como complemento</li>
              <li>Exerc√≠cios chave: agachamento, avan√ßo, eleva√ß√£o p√©lvica, stiff, puxada e desenvolvimento</li>
            </ul>
            <p class="small">V√≠deos de execu√ß√£o sugeridos:</p>
            <a class="video-link" target="_blank" href="https://www.youtube.com/results?search_query=eleva%C3%A7%C3%A3o+p%C3%A9lvica+execu%C3%A7%C3%A3o+correta">
              <span>‚ñ∂</span><span>Eleva√ß√£o p√©lvica</span>
            </a>
            <a class="video-link" target="_blank" href="https://www.youtube.com/results?search_query=avan%C3%A7o+passada+execu%C3%A7%C3%A3o+correta">
              <span>‚ñ∂</span><span>Avan√ßo / passada</span>
            </a>
            <a class="video-link" target="_blank" href="https://www.youtube.com/results?search_query=puxada+alta+execu%C3%A7%C3%A3o+correta">
              <span>‚ñ∂</span><span>Puxada alta</span>
            </a>
          </div>
        </div>

        <p class="small">
          Dica ninja: escolha 1‚Äì2 v√≠deos de cada exerc√≠cio que voc√™ gosta e salve nos favoritos do navegador. 
          A√≠ seu ‚ÄúNetflix de treino‚Äù fica pronto em 2 cliques.
        </p>
      </div>

      <!-- SUPLEMENTOS / VITAMINAS -->
      <div class="card">
        <h2>Vitamina & Suplementos ‚Äì Organiza√ß√£o</h2>
        <p class="small">
          Sempre siga orienta√ß√£o do seu m√©dico. Aqui √© s√≥ uma forma organizada de visualizar a rotina.
        </p>

        <h3>Manh√£</h3>
        <ul class="small">
          <li><strong>Whey zero</strong> ‚Äì ao acordar ou p√≥s-treino</li>
          <li><strong>Creatina (3 g)</strong> ‚Äì com qualquer refei√ß√£o</li>
          <li><strong>Vitamina C</strong></li>
          <li><strong>Manipulado di√°rio</strong> (protocolo hormonal)</li>
          <li><strong>C√°lcio + Magn√©sio + Pot√°ssio</strong></li>
        </ul>

        <div class="pill-row">
          <span class="pill-tag">M√∫sculo: whey + creatina</span>
          <span class="pill-tag">Hormonal: manipulado</span>
          <span class="pill-tag">Equil√≠brio: eletr√≥litos</span>
        </div>

        <h3 style="margin-top:12px;">Noite</h3>
        <ul class="small">
          <li><strong>Vitamina D</strong> ‚Äì com refei√ß√£o que tenha alguma gordura</li>
          <li>Hidrata√ß√£o boa at√© o fim do dia</li>
        </ul>

        <h3 style="margin-top:12px;">Semanal</h3>
        <ul class="small">
          <li><strong>Monjaro</strong> ‚Äì aplica√ß√£o 1x/semana, conforme orienta√ß√£o m√©dica</li>
        </ul>

        <p class="small">
          Sentiu algo estranho (tontura, fadiga fora da curva, etc.)? 
          Anota na aba de <strong>observa√ß√µes da semana</strong> e leva isso pra consulta. 
          Seu m√©dico ama dados organizados.
        </p>
      </div>

    </div>
  </div>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Firebase (CDN, modo m√≥dulo) + L√≥gica do app -->
  <script type="module">
    // Import Firebase (vers√£o modular, via CDN)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signInWithEmailAndPassword,
      createUserWithEmailAndPassword,
      signOut
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import {
      getFirestore,
      doc,
      setDoc,
      getDoc,
      collection,
      getDocs,
      query,
      orderBy,
      deleteDoc
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    // === CONFIGURA√á√ÉO DO SEU PROJETO FIREBASE ===
    const firebaseConfig = {
      apiKey: "AIzaSyBbz-DjxSv2S2g1qkWca8YpNn3g7C4Oic0",
      authDomain: "evolucao-dark-premium.firebaseapp.com",
      projectId: "evolucao-dark-premium",
      storageBucket: "evolucao-dark-premium.firebasestorage.app",
      messagingSenderId: "1041789751060",
      appId: "1:1041789751060:web:eb2afd0d1a4af526e0fc01"
    };

    // Inicializa Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Refer√™ncias de DOM
    const authCard = document.getElementById("authCard");
    const appDiv = document.getElementById("app");
    const authEmail = document.getElementById("authEmail");
    const authPassword = document.getElementById("authPassword");
    const authTitle = document.getElementById("authTitle");
    const authMainBtn = document.getElementById("authMainBtn");
    const authSecondaryBtn = document.getElementById("authSecondaryBtn");
    const toggleAuthMode = document.getElementById("toggleAuthMode");
    const authModeText = document.getElementById("authModeText");
    const authError = document.getElementById("authError");

    const topbarUser = document.getElementById("topbarUser");
    const loggedEmail = document.getElementById("loggedEmail");
    const logoutBtn = document.getElementById("logoutBtn");

    const startWeightInput = document.getElementById("startWeight");
    const startWaistInput = document.getElementById("startWaist");
    const goalWeightInput = document.getElementById("goalWeight");
    const goalWaistInput = document.getElementById("goalWaist");
    const goalDateInput = document.getElementById("goalDate");
    const saveMetaBtn = document.getElementById("saveMetaBtn");

    const weekSelect = document.getElementById("week");
    const pesoInput = document.getElementById("peso");
    const cinturaInput = document.getElementById("cintura");
    const energiaInput = document.getElementById("energia");
    const humorInput = document.getElementById("humor");
    const sonoInput = document.getElementById("sono");
    const obsInput = document.getElementById("obs");
    const addWeekBtn = document.getElementById("addWeekBtn");
    const resetWeeksBtn = document.getElementById("resetWeeksBtn");

    const historyTableBody = document.querySelector("#historyTable tbody");
    const motivationText = document.getElementById("motivationText");

    let currentUser = null;
    let progressData = [];
    let metaData = null;
    let chartInstance = null;
    let authMode = "login"; // "login" ou "signup"

    // --- Fun√ß√µes auxiliares ---

    function setAuthMode(mode) {
      authMode = mode;
      authError.style.display = "none";
      authError.textContent = "";
      if (mode === "login") {
        authTitle.textContent = "Entrar na sua conta";
        authMainBtn.textContent = "Entrar";
        authSecondaryBtn.textContent = "Quero criar uma conta";
        authModeText.innerHTML = 'Ainda n√£o tem conta? <button class="toggle-auth" id="toggleAuthModeInner">Criar conta</button>';
      } else {
        authTitle.textContent = "Criar nova conta";
        authMainBtn.textContent = "Criar conta";
        authSecondaryBtn.textContent = "J√° tenho conta";
        authModeText.innerHTML = 'J√° tem conta? <button class="toggle-auth" id="toggleAuthModeInner">Entrar</button>';
      }
      // Re-anexar evento ao bot√£o interno
      const innerToggle = document.getElementById("toggleAuthModeInner");
      if (innerToggle) {
        innerToggle.addEventListener("click", () => {
          setAuthMode(authMode === "login" ? "signup" : "login");
        });
      }
    }

    function showError(msg) {
      authError.style.display = "block";
      authError.textContent = msg;
    }

    function hideError() {
      authError.style.display = "none";
      authError.textContent = "";
    }

    function showLoggedUI(user) {
      authCard.style.display = "none";
      appDiv.style.display = "block";
      topbarUser.style.display = "flex";
      loggedEmail.textContent = user.email;
    }

    function showLoggedOutUI() {
      authCard.style.display = "block";
      appDiv.style.display = "none";
      topbarUser.style.display = "none";
      loggedEmail.textContent = "";
      progressData = [];
      metaData = null;
      renderTable();
      renderChart();
      motivationText.textContent = "Preencha suas metas ali em cima e comece a registrar as semanas. A partir da√≠ eu viro seu narrador motivacional oficial. üòà";
      startWeightInput.value = "";
      startWaistInput.value = "";
      goalWeightInput.value = "";
      goalWaistInput.value = "";
      goalDateInput.value = "";
    }

    // --- Firebase Auth ---

    authMainBtn.addEventListener("click", async () => {
      hideError();
      const email = authEmail.value.trim();
      const password = authPassword.value.trim();
      if (!email || !password) {
        showError("Preencha e-mail e senha.");
        return;
      }
      try {
        if (authMode === "login") {
          await signInWithEmailAndPassword(auth, email, password);
        } else {
          await createUserWithEmailAndPassword(auth, email, password);
        }
      } catch (err) {
        console.error(err);
        let msg = "Erro ao autenticar.";
        if (err.code === "auth/email-already-in-use") msg = "Este e-mail j√° est√° em uso.";
        if (err.code === "auth/invalid-email") msg = "E-mail inv√°lido.";
        if (err.code === "auth/weak-password") msg = "Senha muito fraca. Tente algo com pelo menos 6 caracteres.";
        if (err.code === "auth/user-not-found" || err.code === "auth/wrong-password") msg = "E-mail ou senha incorretos.";
        showError(msg);
      }
    });

    authSecondaryBtn.addEventListener("click", () => {
      setAuthMode(authMode === "login" ? "signup" : "login");
    });

    toggleAuthMode.addEventListener("click", () => {
      setAuthMode(authMode === "login" ? "signup" : "login");
    });

    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
    });

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        currentUser = user;
        showLoggedUI(user);
        await loadMeta();
        await loadWeeks();
        updateMotivation();
      } else {
        currentUser = null;
        showLoggedOutUI();
      }
    });

    // --- Firestore: Metas ---

    async function loadMeta() {
      if (!currentUser) return;
      const ref = doc(db, "users", currentUser.uid, "meta", "default");
      const snap = await getDoc(ref);
      if (snap.exists()) {
        metaData = snap.data();
        if (metaData.startWeight != null) startWeightInput.value = metaData.startWeight;
        if (metaData.startWaist != null) startWaistInput.value = metaData.startWaist;
        if (metaData.goalWeight != null) goalWeightInput.value = metaData.goalWeight;
        if (metaData.goalWaist != null) goalWaistInput.value = metaData.goalWaist;
        if (metaData.goalDate) goalDateInput.value = metaData.goalDate;
      } else {
        metaData = null;
      }
      updateMotivation();
    }

    saveMetaBtn.addEventListener("click", async () => {
      if (!currentUser) return;
      const startWeight = parseFloat(startWeightInput.value.replace(",", "."));
      const startWaist = startWaistInput.value ? parseFloat(startWaistInput.value.replace(",", ".")) : null;
      const goalWeight = goalWeightInput.value ? parseFloat(goalWeightInput.value.replace(",", ".")) : null;
      const goalWaist = goalWaistInput.value ? parseFloat(goalWaistInput.value.replace(",", ".")) : null;
      const goalDate = goalDateInput.value || null;

      if (isNaN(startWeight)) {
        alert("Informe pelo menos o peso inicial.");
        return;
      }

      const ref = doc(db, "users", currentUser.uid, "meta", "default");
      const payload = {
        startWeight,
        startWaist,
        goalWeight: goalWeight || null,
        goalWaist: goalWaist || null,
        goalDate,
        updatedAt: new Date().toISOString()
      };

      await setDoc(ref, payload);
      metaData = payload;
      updateMotivation();
      alert("Metas salvas com sucesso!");
    });

    // --- Firestore: Semanas ---

    async function loadWeeks() {
      if (!currentUser) return;
      const ref = collection(db, "users", currentUser.uid, "weeks");
      const q = query(ref, orderBy("week", "asc"));
      const snap = await getDocs(q);
      progressData = [];
      snap.forEach((docSnap) => {
        progressData.push(docSnap.data());
      });
      renderTable();
      renderChart();
      updateMotivation();
    }

    addWeekBtn.addEventListener("click", async () => {
      if (!currentUser) return;

      const week = parseInt(weekSelect.value, 10);
      const pesoVal = pesoInput.value.replace(",", ".");
      const cinturaVal = cinturaInput.value.replace(",", ".");
      const peso = parseFloat(pesoVal);
      const cintura = cinturaVal ? parseFloat(cinturaVal) : null;
      const energia = energiaInput.value ? parseInt(energiaInput.value, 10) : null;
      const humor = humorInput.value ? parseInt(humorInput.value, 10) : null;
      const sono = sonoInput.value ? parseInt(sonoInput.value, 10) : null;
      const obs = obsInput.value.trim();

      if (!week || isNaN(week)) {
        alert("Selecione a semana.");
        return;
      }
      if (isNaN(peso)) {
        alert("Informe o peso (kg).");
        return;
      }

      const ref = doc(db, "users", currentUser.uid, "weeks", `week-${week}`);
      const entry = {
        week,
        peso,
        cintura: cintura ?? null,
        energia,
        humor,
        sono,
        obs,
        updatedAt: new Date().toISOString()
      };

      await setDoc(ref, entry);

      // Atualiza no array em mem√≥ria
      const existingIndex = progressData.findIndex(d => d.week === week);
      if (existingIndex >= 0) {
        progressData[existingIndex] = entry;
      } else {
        progressData.push(entry);
      }

      renderTable();
      renderChart();
      updateMotivation();
      alert("Semana salva com sucesso!");
    });

    resetWeeksBtn.addEventListener("click", async () => {
      if (!currentUser) return;
      const confirmar = confirm("Tem certeza que deseja apagar TODOS os registros de semanas deste usu√°rio?");
      if (!confirmar) return;

      const ref = collection(db, "users", currentUser.uid, "weeks");
      const snap = await getDocs(ref);
      const deletions = [];
      snap.forEach((docSnap) => {
        deletions.push(deleteDoc(docSnap.ref));
      });
      await Promise.all(deletions);

      progressData = [];
      renderTable();
      renderChart();
      updateMotivation();
      alert("Registros de semanas apagados para este usu√°rio.");
    });

    // --- Renderiza√ß√£o Tabela & Gr√°fico ---

    function renderTable() {
      historyTableBody.innerHTML = "";
      const sorted = [...progressData].sort((a, b) => a.week - b.week);
      for (const row of sorted) {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td><span class="pill">Semana ${row.week}</span></td>
          <td>${row.peso ?? ""}</td>
          <td>${row.cintura ?? ""}</td>
          <td>${row.energia ?? ""}</td>
          <td>${row.humor ?? ""}</td>
          <td>${row.sono ?? ""}</td>
          <td>${row.obs ?? ""}</td>
        `;
        historyTableBody.appendChild(tr);
      }
    }

    function renderChart() {
      const ctx = document.getElementById("progressChart").getContext("2d");
      const sorted = [...progressData].sort((a, b) => a.week - b.week);
      const labels = sorted.map(d => "S" + d.week);
      const pesos = sorted.map(d => d.peso ?? null);
      const cinturas = sorted.map(d => d.cintura ?? null);

      if (!labels.length) {
        if (chartInstance) {
          chartInstance.destroy();
          chartInstance = null;
        }
        return;
      }

      if (chartInstance) {
        chartInstance.destroy();
      }

      chartInstance = new Chart(ctx, {
        type: "line",
        data: {
          labels,
          datasets: [
            {
              label: "Peso (kg)",
              data: pesos,
              borderColor: "#4cc9f0",
              backgroundColor: "rgba(76,201,240,0.1)",
              borderWidth: 2,
              tension: 0.35,
              pointRadius: 3
            },
            {
              label: "Cintura (cm)",
              data: cinturas,
              borderColor: "#f72585",
              backgroundColor: "rgba(247,37,133,0.1)",
              borderWidth: 2,
              tension: 0.35,
              pointRadius: 3
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              labels: { color: "#d0d3ea", usePointStyle: true }
            }
          },
          scales: {
            x: {
              ticks: { color: "#9ba0c2" },
              grid: { color: "rgba(255,255,255,0.03)" }
            },
            y: {
              ticks: { color: "#9ba0c2" },
              grid: { color: "rgba(255,255,255,0.03)" }
            }
          }
        }
      });
    }

    // --- Mensagens motivacionais engra√ßadas ---

    function updateMotivation() {
      // Se n√£o estiver logado, texto padr√£o j√° foi setado
      if (!currentUser) return;

      const totalSemanas = progressData.length;
      if (!metaData && totalSemanas === 0) {
        motivationText.textContent =
          "Conta criada, shape ainda n√£o. Salve suas metas ali em cima e registre a Semana 1 pra come√ßar o modo Dark Premium. üòà";
        return;
      }

      const start = metaData?.startWeight ?? null;
      const goal = metaData?.goalWeight ?? null;

      let last = null;
      if (progressData.length) {
        const sorted = [...progressData].sort((a, b) => a.week - b.week);
        last = sorted[sorted.length - 1];
      }

      if (!last) {
        motivationText.textContent =
          "Metas salvas. Agora falta o principal: preencher pelo menos uma semana. A planilha n√£o engorda nem emagrece, mas ajuda a mente.";
        return;
      }

      const lastPeso = last.peso;
      let texto = "";

      if (goal && lastPeso <= goal) {
        texto =
          "üéØ Meta batida! Balan√ßa j√° confirmou. Agora a miss√£o √© manter o resultado sem ligar o modo ‚Äòcelebra√ß√£o infinita de pizza‚Äô. Parab√©ns, lenda!";
      } else if (start && lastPeso < start) {
        const diff = (start - lastPeso).toFixed(1);
        texto =
          `üî• Voc√™ j√° mandou embora cerca de ${diff} kg desde o in√≠cio. ` +
          "Isso √© basicamente um pacote grande de arroz indo embora do seu corpo. Continue assim que o espelho vai ter que atualizar o firmware.";
      } else if (start && lastPeso > start) {
        const diff = (lastPeso - start).toFixed(1);
        texto =
          `üìà O peso subiu uns ${diff} kg desde o come√ßo. Relaxa, n√£o √© fim de temporada, √© s√≥ um epis√≥dio de filler. ` +
          "Revisa sono, comida e treino desta semana e volta pro modo hist√≥ria principal.";
      } else if (totalSemanas >= 4) {
        texto =
          "Voc√™ j√° registrou v√°rias semanas seguidas. Isso se chama consist√™ncia, e consist√™ncia √© o hack secreto que as pessoas querem encontrar em c√°psula.";
      } else {
        texto =
          "√ìtimo come√ßo! Cada semana registrada √© um ‚Äòn√£o‚Äô que voc√™ deu para a pregui√ßa. Mant√©m o ritmo que o resultado vem, queira a balan√ßa ou n√£o.";
      }

      motivationText.textContent = texto;
    }

    // Inicia modo de autentica√ß√£o padr√£o
    setAuthMode("login");
  </script>
</body>
</html>
